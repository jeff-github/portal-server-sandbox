
================================================================================
TWO-LEVEL DOCUMENTATION STRUCTURE
================================================================================

KEY INSIGHT:
  prd-flutter-event-sourcing.md is NOT a Flutter module spec
  It's a GENERIC event-sourcing system architecture description!

================================================================================
LEVEL 1: GENERIC EVENT-SOURCING SYSTEM (Reusable)
================================================================================

ðŸ“¦ prd-event-sourcing-system.md
   â””â”€ (renamed from prd-flutter-event-sourcing.md)

   Content:
   â”œâ”€ Architecture Overview (preamble)
   â”œâ”€ High-Level Design
   â”œâ”€ Component Architecture
   â”œâ”€ Data Flow
   â”‚
   â””â”€ Requirements (de-fluttered):
      â”œâ”€ REQ-p01000: Event Sourcing Client Interface
      â”œâ”€ REQ-p01001: Offline Event Queue
      â”œâ”€ REQ-p01002: Optimistic Concurrency Control
      â”œâ”€ REQ-p01003: Immutable Event Storage â­
      â”œâ”€ REQ-p01004: Schema Version Management
      â”œâ”€ REQ-p01005: Real-time Event Subscription
      â”œâ”€ REQ-p01006: Type-Safe Materialized View Queries
      â”œâ”€ REQ-p01007: Error Handling and Diagnostics
      â”œâ”€ REQ-p01008: Event Replay and Time Travel (optional)
      â”œâ”€ REQ-p01009: Encryption at Rest (optional)
      â”œâ”€ REQ-p01010: Multi-tenancy Support â­
      â”œâ”€ REQ-p01011: Event Transformation (optional)
      â”œâ”€ REQ-p01012: Batch Event Operations (optional)
      â”œâ”€ REQ-p01013: GraphQL/gRPC Transport (optional)
      â”œâ”€ REQ-p01014: Observability and Monitoring
      â”œâ”€ REQ-p01015: Automated Testing Support
      â”œâ”€ REQ-p01016: Performance Benchmarking
      â”œâ”€ REQ-p01017: Backward Compatibility
      â”œâ”€ REQ-p01018: Security Audit
      â””â”€ REQ-p01019: Phased Implementation

   Characteristics:
   âœ… 100% app-agnostic (no Flutter/Dart references)
   âœ… No diary/clinical trial terminology
   âœ… Pure event-sourcing patterns
   âœ… Could apply to ANY event-sourced application

   Transformations Applied:
   â€¢ 'Flutter Event Sourcing Module' â†’ 'Event Sourcing System'
   â€¢ 'Dart/Flutter package' â†’ 'software module'
   â€¢ 'Dart classes' â†’ 'strongly-typed data structures'
   â€¢ 'mobile applications' â†’ 'client applications'
   â€¢ 'SQLite/Hive' â†’ 'local persistent storage'

================================================================================
LEVEL 2: DIARY-SPECIFIC IMPLEMENTATION (Refinements Only)
================================================================================

ðŸ“‹ prd-database.md (Perfect as-is! âœ¨)
   â””â”€ Executive summary of diary database

   Content:
   â”œâ”€ Clinical Trial Database Architecture
   â”œâ”€ REQ-p00003: Separate Database Per Sponsor
   â”‚  â””â”€ Implements: REQ-p01010 â­ (multi-tenancy)
   â”‚  â””â”€ Adds: Clinical trial sponsor isolation context
   â”‚
   â””â”€ REQ-p00013: Complete Data Change History
      â””â”€ Implements: REQ-p01003 â­ (immutable events)
      â””â”€ Adds: Clinical trial audit trail specifics

   Cross-Reference Added:
   > **See**: prd-event-sourcing-system.md for generic event sourcing

   What It Does NOT Repeat:
   âŒ Generic event sourcing concepts (in generic layer)
   âŒ CQRS architecture (in generic layer)
   âŒ Offline queue mechanics (in generic layer)

   What It DOES Add:
   âœ… Clinical trial context
   âœ… Sponsor-specific multi-tenancy
   âœ… Patient data protection
   âœ… Multi-site organization

ðŸ“‹ prd-database-event-sourcing.md (Minor update)
   â””â”€ Event sourcing with FDA compliance context

   Content:
   â””â”€ REQ-p00004: Immutable Audit Trail via Event Sourcing
      â””â”€ Implements: REQ-p01003 â­ (immutable events)
      â””â”€ Adds: FDA 21 CFR Part 11 compliance requirements

   Cross-Reference Added:
   > **See**: prd-event-sourcing-system.md for event sourcing patterns


================================================================================
BEFORE vs AFTER
================================================================================

BEFORE:
  prd-flutter-event-sourcing.md
    Problem: Name suggests Flutter-specific
    Problem: Content is 95% generic but has Flutter terminology
    Problem: Unclear relationship to prd-database.md

AFTER:
  prd-event-sourcing-system.md (generic)
    â”œâ”€ Clear purpose: Generic system architecture
    â”œâ”€ De-fluttered: 100% app-agnostic
    â””â”€ Reusable: Can apply to any event-sourced app

  prd-database.md (diary refinement)
    â”œâ”€ Clear purpose: Diary-specific implementation
    â”œâ”€ Links to generic: Implements REQ-p01003, REQ-p01010
    â””â”€ Focused: Only diary-specific refinements

================================================================================
HOW TO USE THE TOOLS
================================================================================

Step 1: Extract
  $ python3 tools/extract_requirements.py \
      spec/prd-flutter-event-sourcing.md \
      spec/prd-database.md

Step 2: Transform (de-flutter)
  $ python3 tools/transform_requirements.py --deflutter

Step 3: Update implements links
  $ python3 tools/transform_requirements.py \
      --update-implements REQ-p00003:REQ-p01010
  $ python3 tools/transform_requirements.py \
      --update-implements REQ-p00013:REQ-p01003

Step 4: Create config
  $ python3 tools/recombine_requirements.py --create-config
  # Edit untracked-notes/refactor-config-template.json

Step 5: Recombine
  $ python3 tools/recombine_requirements.py \
      --config untracked-notes/refactor-config.json

Step 6: Review & Validate
  $ diff -u spec/prd-flutter-event-sourcing.md \
           spec-refactored/prd-event-sourcing-system.md
  $ python3 tools/requirements/validate_requirements.py

================================================================================
KEY BENEFITS
================================================================================

âœ… Clear Separation
   Generic system architecture vs diary-specific refinement

âœ… No Repetition
   Diary docs reference generic, don't duplicate

âœ… Better Naming
   'Event Sourcing System' > 'Flutter Event Sourcing Module'

âœ… REQ Preservation
   All IDs unchanged (p01000-p01019, p00003, p00013)

âœ… Reusability
   Generic layer usable for other event-sourced apps

âœ… Package Ready
   Generic layer ready for extraction as standalone package

================================================================================
VALIDATION CHECKLIST
================================================================================

Before declaring success, verify:

  [ ] All REQ-IDs preserved (p01000-p01019, p00003, p00013, p00004)
  [ ] No Flutter/Dart refs in prd-event-sourcing-system.md
  [ ] Preamble from prd-flutter-event-sourcing.md reused
  [ ] Diary files add 'Implements: REQ-p01XXX' links
  [ ] Diary files add 'See: prd-event-sourcing-system.md' refs
  [ ] Diary files don't repeat generic content
  [ ] validate_requirements.py passes
  [ ] Traceability matrix still valid
  [ ] prd-database.md content preserved (it was perfect!)

