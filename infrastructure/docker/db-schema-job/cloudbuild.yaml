---
# infrastructure/docker/db-schema-job/cloudbuild.yaml
#
# Build and push db-schema-job container image to Artifact Registry
# Also consolidates schema files and uploads to GCS
#
# Usage (from repo root):
#   gcloud builds submit --config=infrastructure/docker/db-schema-job/cloudbuild.yaml .
#
# IMPLEMENTS REQUIREMENTS:
#   REQ-d00057: Automated database schema deployment
#   REQ-o00004: Database Schema Deployment

steps:
  # Step 1: Generate version tag from git or use build ID
  - name: 'gcr.io/cloud-builders/git'
    id: 'get-version'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        git status
        # Try to get git short SHA, fall back to build ID
        echo "latest" > /workspace/version.txt
        echo "Using build ID: $(cat /workspace/version.txt)"
        # if git rev-parse --short HEAD > /workspace/version.txt 2>/dev/null; then
        #   echo "Using git SHA: $(cat /workspace/version.txt)"
        # else
        #   echo "${BUILD_ID:0:7}" > /workspace/version.txt
        #   echo "Using build ID: $(cat /workspace/version.txt)"
        # fi

  # Step 2: Build the container image
  - name: 'gcr.io/cloud-builders/docker'
    id: 'build-image'
    dir: 'infrastructure/docker/db-schema-job'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        VERSION=$(cat /workspace/version.txt)
        docker build \
          -t "${_REGION}-docker.pkg.dev/${_ARTIFACT_PROJECT}/${_REPOSITORY}/db-schema-job:$${VERSION}" \
          -t "${_REGION}-docker.pkg.dev/${_ARTIFACT_PROJECT}/${_REPOSITORY}/db-schema-job:latest" \
          .

  # Step 3: Push with version tag
  - name: 'gcr.io/cloud-builders/docker'
    id: 'push-version-tag'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        VERSION=$(cat /workspace/version.txt)
        docker push "${_REGION}-docker.pkg.dev/${_ARTIFACT_PROJECT}/${_REPOSITORY}/db-schema-job:$${VERSION}"

  # Step 4: Push latest tag
  - name: 'gcr.io/cloud-builders/docker'
    id: 'push-latest-tag'
    args:
      - 'push'
      - '${_REGION}-docker.pkg.dev/${_ARTIFACT_PROJECT}/${_REPOSITORY}/db-schema-job:latest'

substitutions:
  _REGION: 'europe-west9'
  _ARTIFACT_PROJECT: 'cure-hht-admin'
  _REPOSITORY: 'cloud-run-source-deploy'

images:
  - '${_REGION}-docker.pkg.dev/${_ARTIFACT_PROJECT}/${_REPOSITORY}/db-schema-job:latest'

options:
  logging: CLOUD_LOGGING_ONLY
