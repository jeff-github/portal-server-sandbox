# Clinical Trial Diary Database Architecture

**Version**: 1.0
**Audience**: Product Requirements
**Last Updated**: 2025-10-23
**Status**: Active
**Compliance**: FDA 21 CFR Part 11

> **See**: prd-architecture-multi-sponsor.md for multi-sponsor deployment architecture
> **See**: prd-database-event-sourcing.md for Event Sourcing pattern details
> **See**: prd-security-RBAC.md for access control
> **See**: prd-clinical-trials.md for FDA compliance requirements
> **See**: dev-database.md for implementation guide

---

## Executive Summary

A PostgreSQL-based database system for clinical trial patient diary data deployed as **separate Supabase instances per sponsor**, with offline-first mobile app support, complete audit trail for FDA compliance, and multi-site access control.

**Architecture Pattern**: Event Sourcing with CQRS (Command Query Responsibility Segregation)

**Key Features**:
- Immutable event store for complete audit trail
- Materialized read model for fast queries
- Row-level security for multi-site access control
- Offline-first sync with conflict resolution
- Cryptographic tamper detection
- FDA 21 CFR Part 11 compliant

---

## Core Architecture

See **prd-database-event-sourcing.md** for complete Event Sourcing pattern details.

### Quick Overview

**Event Store (record_audit)**:
- Source of truth
- Immutable append-only log
- Every change captured as event
- Provides audit trail for compliance

**Read Model (record_state)**:
- Current state view
- Derived from event store via triggers
- Optimized for queries
- Cannot be directly modified

**Pattern**: Write to event store → Read from read model

---

## Data Identification

### UUID Generation
- **UUIDs generated by mobile app** (client-side)
- Ensures offline-first functionality
- Same UUID used across multiple database instances
- Prevents duplicate key conflicts during sync
- Format: UUID v4 (random)

### Multi-Sponsor Database Architecture

**Deployment Model**: Each sponsor has a dedicated Supabase project (separate PostgreSQL database + Auth instance).

**Sponsor Isolation**:
- Each sponsor = separate Supabase instance
- No shared database infrastructure
- Independent audit trails per sponsor
- Complete data isolation at infrastructure level

**Shared UUID Space**:
- Client-generated UUIDs (UUID v4) enable future data portability
- Same UUID format across all sponsor instances
- Prevents key conflicts if data ever needs to move between sponsors
- Each sponsor's database maintains independent audit trail for same UUID

**See**: prd-architecture-multi-sponsor.md for complete multi-sponsor architecture

---

## Database Enforcement Rules

### 1. Referential Integrity
- Enforced via PostgreSQL foreign key constraints
- Cascading rules defined for deletions (where applicable)
- Orphaned records prevented at database level

### 2. Data Validation
- Database triggers validate data format and ranges
- Required fields enforced via NOT NULL constraints
- CHECK constraints for enum-like fields
- JSONB schema validation via triggers

### 3. Event Store Maintenance
- **Database triggers** automatically update read model when events are written
- Trigger ensures atomic transaction: both event store write and read model update
- Failed transactions rollback both tables
- No application code can bypass event logging

### 4. Read Model Derivation
- Trigger on event store automatically updates read model
- Application cannot directly update read model (enforced by permissions)
- Ensures read model always reflects event history
- Read model can be rebuilt by replaying events

---

## Access Control

See **prd-security-RBAC.md** for complete role definitions and permissions.

### Role Summary
- **User (Patient)**: Read/write own data only
- **Investigator**: Site-scoped read, can annotate
- **Analyst**: Site-scoped read-only, de-identified data
- **Admin**: Global access, all actions logged

### Row-Level Security (RLS)
- PostgreSQL RLS policies enforce access control
- User isolation by patient_id
- Site-based investigator access
- All policies enforced at database level

---

## Conflict Resolution

### Multi-Device Sync Conflicts
- Detected when `parent_audit_id` doesn't match current state
- Client must resolve before server accepts update
- Resolution strategies:
  - User chooses version (client or server)
  - Field-level merge (non-conflicting fields combined)
  - Manual review UI for true conflicts
- Resolution creates new audit entry with conflict metadata

### Investigator vs. User Conflicts
- Not true conflicts - stored as separate layers
- User data remains authoritative
- Investigator corrections stored as annotations
- Both visible to patient on next sync

---

## Data Synchronization

### Offline-First App Architecture
- Mobile app stores data locally (IndexedDB/SQLite)
- Changes queued for sync when online
- Background sync every 15 minutes when connected
- Delta sync: only changed records transmitted

### Sync Protocol
1. App sends: event UUID, data, parent_audit_id, client timestamp
2. Database checks for conflicts (parent_audit_id match)
3. If no conflict: accept and return new audit_id
4. If conflict: return current state and conflict indicator
5. App resolves conflict and resubmits
6. Database writes event to event store and updates read model

### Batch Operations
- App can submit multiple events in single transaction
- All-or-nothing: entire batch succeeds or fails
- Reduces network overhead for catch-up syncs

---

## Data Model Summary

### Core Tables
1. **record_audit** - Event store (immutable event log)
2. **record_state** - Read model (current state view)
3. **investigator_annotations** - Notes/corrections layer
4. **sites** - Clinical trial site information
5. **user_site_assignments** - Patient enrollment per site
6. **investigator_site_assignments** - Investigator access per site
7. **analyst_site_assignments** - Analyst access per site
8. **sync_conflicts** - Multi-device sync conflict tracking

### Key Fields
- **Event UUID**: Client-generated, globally unique identifier (same across databases)
- **Patient ID**: Links to user authentication system
- **Site ID**: Clinical trial site for RBAC
- **Audit ID**: Auto-incrementing event ID, establishes chronological order in event store
- **Parent Audit ID**: Links to previous event for version tracking (Event Sourcing lineage)
- **Data (JSONB)**: Flexible schema for diary events
- **Timestamps**: Client and server, with timezone
- **Change Reason**: Required for all modifications

---

## Performance Considerations

### Indexing Strategy
- Primary keys on all tables
- Indexes on: patient_id, site_id, UUID, timestamps
- GIN index on JSONB columns for fast queries
- Partial indexes for common filters (e.g., pending sync)

### Partitioning
- Event store (record_audit) partitioned by month (performance)
- Old partitions archived to cold storage after 2 years
- Read model (record_state) not partitioned (always small)

### Scaling
- Read replicas for investigator portal queries
- Connection pooling (PgBouncer)
- Materialized views for common aggregate queries
- Automatic vacuum and analyze scheduled

---

## Security Requirements

### Encryption
- Database encrypted at rest (AES-256)
- All connections use TLS 1.3
- JWT tokens for authentication
- Passwords hashed with bcrypt

### Access Logging
- All database connections logged
- Failed authentication attempts logged
- Admin actions logged with justification
- Suspicious patterns trigger alerts

### Backup and Recovery
- Automated backups every 6 hours
- 30-day point-in-time recovery
- Cross-region replication for disaster recovery
- Backup encryption with separate keys

---

## Future Enhancements

### Phase 2 (6-12 months)
- Real-time sync via WebSockets
- Advanced analytics dashboard
- Machine learning for data quality checks
- Integration with electronic health records (EHR)

### Phase 3 (12-24 months)
- Multi-language support
- Blockchain-based audit trail (optional)
- Federated learning across trials
- Advanced query builder for researchers

---

## Success Metrics

### Data Quality
- 100% audit trail completeness (no missing entries)
- <5% sync conflict rate
- <1% manual conflict resolution rate
- 99.9%+ data integrity verification success

### Performance
- <3 seconds average sync time
- <100ms database query latency (95th percentile)
- 99.9% API uptime
- Support 10,000 concurrent users

### Compliance
- Zero critical FDA audit findings
- 100% of corrections properly documented
- Zero unauthorized data access incidents
- 100% backup success rate

---

## Appendix: Database Schema Quick Reference

```
record_audit (INSERT-only event store)
├─ audit_id (PK, auto-increment)
├─ event_uuid (from app)
├─ patient_id
├─ site_id
├─ operation
├─ data (JSONB)
├─ created_by
├─ role
├─ client_timestamp
├─ server_timestamp
├─ parent_audit_id (FK → audit_id)
└─ change_reason

record_state (updatable via triggers only - read model)
├─ event_uuid (PK, from app)
├─ patient_id
├─ site_id
├─ current_data (JSONB)
├─ version
├─ last_audit_id (FK → audit_id)
└─ sync_metadata

investigator_annotations
├─ annotation_id (PK)
├─ event_uuid (FK)
├─ investigator_id
├─ site_id
├─ annotation_text
├─ requires_response
└─ resolved

sites
├─ site_id (PK)
├─ site_name
└─ site_number

user_site_assignments
├─ patient_id (PK)
├─ site_id (FK)
└─ enrolled_at

investigator_site_assignments
├─ investigator_id (PK)
├─ site_id (FK)
└─ access_level

analyst_site_assignments
├─ analyst_id (PK)
├─ site_id (FK)
└─ access_level
```

---

## References

- **Event Sourcing Pattern**: prd-database-event-sourcing.md
- **JSONB Schema**: dev-data-models-jsonb.md
- **Access Control**: prd-security-RBAC.md
- **FDA Compliance**: prd-clinical-trials.md
- **Implementation**: dev-database.md
- **Deployment**: ops-database-setup.md
- **ADR**: docs/adr/ADR-001-event-sourcing-pattern.md

---

**Source**: Extracted and consolidated from db-spec.md
