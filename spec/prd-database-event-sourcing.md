# Event Sourcing Architecture Pattern

**Version**: 1.0
**Audience**: Product Requirements
**Last Updated**: 2025-10-23

> **See**: prd-database.md for complete database architecture
> **See**: dev-database.md for implementation details  
> **See**: docs/adr/ADR-001-event-sourcing-pattern.md for architectural decision rationale

---

## Overview

This system implements **Event Sourcing** - all changes are stored as a sequence of immutable events, with current state derived from replaying those events. This architectural pattern combined with CQRS (Command Query Responsibility Segregation) provides:

- Complete audit trail for FDA 21 CFR Part 11 compliance
- Point-in-time reconstruction of any record
- Event replay capability
- Temporal queries
- Data integrity guarantees

---

## 1. Event Store (record_audit table)

### Purpose
The **source of truth** for all diary data changes. Every modification to patient data is captured as an immutable event.

### Characteristics
- **Immutable append-only log** - no updates or deletes allowed
- Records every state change as an event
- INSERT-only operations
- Database triggers prevent UPDATE/DELETE operations

### Event Structure
Each event contains:
- **Auto-incrementing audit ID** - establishes chronological order
- **Event UUID** - generated by mobile app, globally unique
- **Patient ID** - data owner
- **Site ID** - clinical trial site
- **Full data snapshot (JSONB)** - complete state at this point
- **Actor** - user/investigator/admin who made change
- **Role** - role under which actor was operating
- **Timestamps** - client-side and server-side (with timezone)
- **Change reason** - required for audit trail (FDA requirement)
- **Parent audit ID** - tracks event lineage for versioning
- **Operation** - type of change (CREATE, UPDATE, DELETE, etc.)
- **Conflict metadata** - for multi-device sync resolution

### Capabilities
- Point-in-time reconstruction of any record
- Event replay for read model rebuilding
- Temporal queries ("show me this record as of 2025-01-15")
- Complete change history with attribution
- Tamper-evident via cryptographic hashes 

---

## 2. Read Model (record_state table)

### Purpose
**Materialized view** of current state, optimized for queries. This is the CQRS "read side."

### Characteristics
- One row per diary entry
- Derived from event stream via database triggers
- Automatically updated when events are written to event store
- Optimized for queries with appropriate indexes

### Record Structure
Each row contains:
- **Event UUID** - primary key, generated by app
- **Patient ID** - data owner
- **Site ID** - clinical trial site
- **Current data (JSONB)** - latest state
- **Version number** - count of events for this record
- **Reference to last audit entry** - last_audit_id
- **Sync metadata** - for offline-first app
- **Soft delete flag** - is_deleted (preserves audit trail)
- **Updated timestamp** - when last modified

### Update Rules
- **Application queries this table, not the event store**
- Application **cannot** directly update read model
- Updates enforced via database triggers only
- Can be rebuilt from event store if corrupted
- All writes flow through event store

---

## 3. Event Sourcing Flow

### Write Path (Command Side)
```
1. App submits change â†’ event store (record_audit)
2. Database trigger validates event
3. Event written to event store (INSERT only)
4. Trigger automatically updates read model (record_state)
5. Transaction commits (atomic: both tables updated or both rollback)
```

### Read Path (Query Side)
```
1. App queries read model (record_state) for current data
2. Fast access via indexes
3. No event replay needed for normal queries
```

### Audit/Compliance Path
```
1. Auditor queries event store (record_audit) for history
2. Can reconstruct any point-in-time view
3. Can verify integrity via cryptographic hashes
```

---

## References

- **Complete Architecture**: prd-database.md
- **Implementation Guide**: dev-database.md
- **JSONB Schema**: dev-data-models-jsonb.md
- **ADR**: docs/adr/ADR-001-event-sourcing-pattern.md
- **Database Schema**: database/schema.sql
- **Triggers**: database/triggers.sql

---

**Source**: Extracted from db-spec.md (Event Sourcing Pattern section)
