# Development Specification: Linking Codes

**Document Type**: Development Specification (Implementation Blueprint)
**Audience**: Software Engineers, Backend Developers, DevOps Engineers
**Status**: Draft
**Last Updated**: 2025-01-23

---

## Overview

This document specifies the technical implementation requirements for one-time linking codes that connect mobile app instances to sponsor portals. Linking codes are generated by the sponsor portal and entered into the mobile app to establish the app-to-sponsor association and enable data synchronization.

**Related Documents**:
- Portal Requirements: `spec/prd-portal.md`, `spec/dev-portal.md` (Linking code generation)
- Multi-Sponsor Architecture: `spec/prd-architecture-multi-sponsor.md` (REQ-p00009)

---

# REQ-d00078: Linking Code Validation

**Level**: Dev | **Status**: Draft | **Implements**: p70001

## Rationale

The sponsor portal validates one-time linking codes submitted by mobile app instances. Upon successful validation, the portal issues a long-term JWT that the app uses for future authentication and data synchronization. Each sponsor portal maintains its own linking code records independently.

## Assertions

A. The sponsor portal SHALL validate one-time linking codes submitted by mobile app instances.
B. The sponsor portal SHALL return a long-term JWT for valid linking codes.
C. The sponsor portal SHALL return an error for invalid, expired, or already-used linking codes.
D. The sponsor portal SHALL mark linking codes as used upon successful validation.
E. The sponsor portal SHALL record the app UUID associated with each linking code use.
F. The sponsor portal SHALL implement rate limiting on linking code validation requests.
G. The sponsor portal SHALL log all linking code validation attempts.

*End* *Linking Code Validation* | **Hash**: 0a89ae19
---

# REQ-d00079: Linking Code Pattern Matching

**Level**: Dev | **Status**: Draft | **Implements**: p01043

## Rationale

Pattern-based routing enables the mobile app to identify the correct sponsor portal from a linking code without exposing sponsor selection to users. The two-character prefix approach mirrors proven systems like credit card BIN ranges, allowing for scalable multi-sponsor deployments while maintaining a seamless user experience.

## Assertions

A. The system SHALL implement pattern-based sponsor identification from linking codes.
B. The system SHALL maintain a configurable mapping table for pattern-to-sponsor associations.
C. Each sponsor pattern record SHALL include patternPrefix, sponsorCodename, portalUrl, active status, createdAt timestamp, and optional decommissionedAt timestamp.
D. The system SHALL perform pattern matching using prefix comparison logic.
E. The system SHALL return the sponsorCodename when a linking code matches an active pattern prefix.
F. The system SHALL return a clear error message for unknown linking code patterns.
G. The system SHALL provide an admin API for pattern table management.
H. The admin API SHALL support adding new sponsor patterns.
I. The admin API SHALL support decommissioning sponsors.
J. The system SHALL allow addition of new patterns without requiring service restart.
K. Linking codes SHALL consist of a two-character sponsor prefix followed by an 8-character random alphanumeric identifier (10 characters total, no separators).
L. The system SHALL display linking codes in the format {SS}{XXX}-{XXXXX} where the dash is for readability only and not part of the stored code.
M. Linking codes SHALL use only uppercase letters A-Z and digits 0-9.
N. Linking codes SHALL NOT use visually ambiguous characters: I, 1, O, 0, S, 5, Z, 2.
O. Each sponsor deployment SHALL define a unique two-character sponsor prefix.

*End* *Linking Code Pattern Matching* | **Hash**: 958939ee
---

# REQ-d00081: Linked Device Records

**Level**: Dev | **Status**: Draft | **Implements**: p70001

## Rationale

This requirement defines the storage schema for tracking mobile app instances linked to sponsor portals. Each record maintains the association between a device (identified by app UUID) and the linking codes used to connect it. The schema supports multiple linking codes per device to handle re-enrollment scenarios while preserving audit trail compliance with FDA 21 CFR Part 11.

## Assertions

A. The system SHALL generate linked device record IDs as UUID v7.
B. Each linked device record SHALL associate a device UUID with a sponsor portal patient ID.
C. Each linked device record SHALL reference the linking code used for traceability.
D. Each linked device record SHALL store the timestamp when the linking code was validated.
E. The system SHALL support multiple linking codes per device UUID to handle revocation and reissuance.
F. Each linking code SHALL be associated with only one device UUID.
G. The linked device collection SHALL be readable and writable only by the sponsor portal service account.
H. The system SHALL NOT allow client-side access to linked device records.

*End* *Linked Device Records* | **Hash**: d44ac005
---

## Version History

| Version | Date       | Changes                                         | Ticket |
| ------- | ---------- | ----------------------------------------------- | ------ |
| 1.0     | 2025-01-23 | Initial creation, moved from dev-diary-web.md   | -      |
