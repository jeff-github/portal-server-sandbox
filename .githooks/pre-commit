#!/bin/bash
# =====================================================
# Pre-Commit Hook: Orchestrator
# =====================================================
#
# This hook orchestrates validation by calling plugin hooks.
#
# Plugins (in tools/claude-marketplace/):
# 1. anspar-workflow - Enforces active ticket requirement
# 2. Dockerfile linting (hadolint) - built-in
# 3. anspar-traceability-matrix - Auto-regenerates matrices on spec/ changes
# 4. anspar-requirement-validation - Validates requirement format and links
# 5. anspar-spec-compliance - Enforces spec/ directory compliance rules
#
# To install this hook:
#   git config core.hooksPath .githooks
#
# To install hadolint (recommended):
#   Ubuntu/Debian: sudo apt-get install hadolint
#   macOS: brew install hadolint
#   Manual: wget -O /usr/local/bin/hadolint https://github.com/hadolint/hadolint/releases/latest/download/hadolint-Linux-x86_64 && chmod +x /usr/local/bin/hadolint
#
# To bypass this hook (NOT RECOMMENDED):
#   git commit --no-verify
#
# =====================================================

set -e

# =====================================================
# 0. Branch Protection - Block Commits to Main
# =====================================================

CURRENT_BRANCH=$(git branch --show-current)

if [ "$CURRENT_BRANCH" = "main" ] || [ "$CURRENT_BRANCH" = "master" ]; then
    echo "âŒ ERROR: Direct commits to '$CURRENT_BRANCH' branch are not allowed!"
    echo ""
    echo "This repository enforces a feature branch workflow."
    echo "All changes must go through pull requests."
    echo ""
    echo "To fix this:"
    echo "  1. Create a feature branch: git checkout -b feature/your-feature-name"
    echo "  2. Commit your changes to the feature branch"
    echo "  3. Push and create a pull request"
    echo ""
    echo "To move this commit to a feature branch:"
    echo "  git branch feature/your-feature-name"
    echo "  git reset --soft HEAD~1"
    echo "  git checkout feature/your-feature-name"
    echo "  git commit"
    echo ""
    exit 1
fi

# =====================================================
# 1. Workflow Enforcement (Plugin)
# =====================================================

WORKFLOW_PRECOMMIT_HOOK="tools/claude-marketplace/anspar-workflow/hooks/pre-commit"
if [ -f "$WORKFLOW_PRECOMMIT_HOOK" ]; then
    "$WORKFLOW_PRECOMMIT_HOOK" || exit 1
else
    echo "âš ï¸  WARNING: Workflow enforcement plugin not found: $WORKFLOW_PRECOMMIT_HOOK"
    echo "   Install: See tools/claude-marketplace/anspar-workflow/README.md"
    echo ""
fi

# =====================================================
# 2. Dockerfile Linting
# =====================================================

# Check if any Dockerfiles are being committed
DOCKERFILES_CHANGED=$(git diff --cached --name-only --diff-filter=ACM | grep -E '(Dockerfile|\.dockerfile)$' || true)

if [ -n "$DOCKERFILES_CHANGED" ]; then
    echo "ðŸ³ Linting Dockerfiles..."
    echo ""

    # Check if hadolint is installed
    if command -v hadolint &> /dev/null; then
        HADOLINT_FAILED=0

        while IFS= read -r dockerfile; do
            echo "  Checking: $dockerfile"
            if ! hadolint "$dockerfile"; then
                HADOLINT_FAILED=1
            fi
        done <<< "$DOCKERFILES_CHANGED"

        if [ $HADOLINT_FAILED -eq 1 ]; then
            echo ""
            echo "âŒ Dockerfile linting failed!"
            echo ""
            echo "Fix the errors above before committing."
            echo "See https://github.com/hadolint/hadolint for rules."
            echo ""
            echo "To bypass this check (NOT RECOMMENDED):"
            echo "  git commit --no-verify"
            exit 1
        fi

        echo ""
        echo "âœ… Dockerfile linting passed!"
        echo ""
    else
        echo "âš ï¸  WARNING: hadolint not installed - skipping Dockerfile linting"
        echo "   Install: https://github.com/hadolint/hadolint#install"
        echo ""
    fi
fi

# =====================================================
# 3. Traceability Matrix Regeneration (Plugin)
# =====================================================

TRACEABILITY_HOOK="tools/claude-marketplace/anspar-traceability-matrix/hooks/pre-commit-traceability-matrix"
if [ -f "$TRACEABILITY_HOOK" ]; then
    "$TRACEABILITY_HOOK" || exit 1
else
    echo "âš ï¸  WARNING: Traceability matrix plugin not found: $TRACEABILITY_HOOK"
    echo "   Install: See tools/claude-marketplace/anspar-traceability-matrix/README.md"
    echo ""
fi

# =====================================================
# 4. Requirement Validation (Plugin)
# =====================================================

REQUIREMENT_VALIDATION_HOOK="tools/claude-marketplace/anspar-requirement-validation/hooks/pre-commit-requirement-validation"
if [ -f "$REQUIREMENT_VALIDATION_HOOK" ]; then
    "$REQUIREMENT_VALIDATION_HOOK" || exit 1
else
    echo "âš ï¸  WARNING: Requirement validation plugin not found: $REQUIREMENT_VALIDATION_HOOK"
    echo "   Install: See tools/claude-marketplace/anspar-requirement-validation/README.md"
    echo ""
fi

# =====================================================
# 5. Spec Compliance Validation (Plugin)
# =====================================================

SPEC_COMPLIANCE_HOOK="tools/claude-marketplace/anspar-spec-compliance/hooks/pre-commit-spec-compliance"
if [ -f "$SPEC_COMPLIANCE_HOOK" ]; then
    "$SPEC_COMPLIANCE_HOOK" || exit 1
else
    echo "âš ï¸  WARNING: Spec compliance plugin not found: $SPEC_COMPLIANCE_HOOK"
    echo "   Install: See tools/claude-marketplace/anspar-spec-compliance/README.md"
    echo ""
fi

# =====================================================
# All Validations Passed
# =====================================================

exit 0
