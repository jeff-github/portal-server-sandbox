#!/bin/bash
# =====================================================
# Pre-Commit Hook: Plugin Orchestrator
# =====================================================
#
# Auto-discovers and executes pre-commit hooks from all
# installed Claude Code plugins in anspar-cc-plugins.
#
# Plugin Discovery:
#   Scans: tools/anspar-cc-plugins/plugins/*/hooks/pre-commit
#   Executes: All found hooks in alphabetical order
#
# Built-in Checks:
#   - Branch protection (blocks commits to main/master)
#   - Dockerfile linting (if hadolint available)
#
# To install this hook:
#   git config core.hooksPath .githooks
#
# To bypass (NOT RECOMMENDED):
#   git commit --no-verify
#
# =====================================================

set -e

# =====================================================
# 0. Branch Protection - Block Commits to Main
# =====================================================

CURRENT_BRANCH=$(git branch --show-current)

if [ "$CURRENT_BRANCH" = "main" ] || [ "$CURRENT_BRANCH" = "master" ]; then
    echo "‚ùå ERROR: Direct commits to '$CURRENT_BRANCH' branch are not allowed!"
    echo ""
    echo "This repository enforces a feature branch workflow."
    echo "All changes must go through pull requests."
    echo ""
    echo "To fix this:"
    echo "  1. Create a feature branch: git checkout -b feature/your-feature-name"
    echo "  2. Commit your changes to the feature branch"
    echo "  3. Push and create a pull request"
    echo ""
    echo "To move this commit to a feature branch:"
    echo "  git branch feature/your-feature-name"
    echo "  git reset --soft HEAD~1"
    echo "  git checkout feature/your-feature-name"
    echo "  git commit"
    echo ""
    exit 1
fi

# =====================================================
# 1. Auto-Discover and Execute Plugin Hooks
# =====================================================

PLUGIN_DIR="tools/anspar-cc-plugins/plugins"

if [ -d "$PLUGIN_DIR" ]; then
    # Find all plugin pre-commit hooks
    PLUGIN_HOOKS=$(find "$PLUGIN_DIR" -type f -path "*/hooks/pre-commit" 2>/dev/null | sort)

    if [ -n "$PLUGIN_HOOKS" ]; then
        while IFS= read -r hook; do
            PLUGIN_NAME=$(echo "$hook" | sed 's|.*/plugins/\([^/]*\)/.*|\1|')

            # Execute the hook if it's executable
            if [ -x "$hook" ]; then
                if ! "$hook"; then
                    echo ""
                    echo "‚ùå Plugin hook failed: $PLUGIN_NAME"
                    echo "   Hook: $hook"
                    exit 1
                fi
            fi
        done <<< "$PLUGIN_HOOKS"
    fi
fi

# =====================================================
# 2. Dockerfile Linting (Built-in)
# =====================================================

# Check if any Dockerfiles are being committed
DOCKERFILES_CHANGED=$(git diff --cached --name-only --diff-filter=ACM | grep -E '(Dockerfile|\.dockerfile)$' || true)

if [ -n "$DOCKERFILES_CHANGED" ]; then
    echo "üê≥ Linting Dockerfiles..."
    echo ""

    # Check if hadolint is installed
    if command -v hadolint &> /dev/null; then
        HADOLINT_FAILED=0

        while IFS= read -r dockerfile; do
            echo "  Checking: $dockerfile"
            if ! hadolint "$dockerfile"; then
                HADOLINT_FAILED=1
            fi
        done <<< "$DOCKERFILES_CHANGED"

        if [ $HADOLINT_FAILED -eq 1 ]; then
            echo ""
            echo "‚ùå Dockerfile linting failed!"
            echo ""
            echo "Fix the errors above before committing."
            echo "See https://github.com/hadolint/hadolint for rules."
            echo ""
            echo "To bypass this check (NOT RECOMMENDED):"
            echo "  git commit --no-verify"
            exit 1
        fi

        echo ""
        echo "‚úÖ Dockerfile linting passed!"
        echo ""
    else
        echo "‚ö†Ô∏è  WARNING: hadolint not installed - skipping Dockerfile linting"
        echo "   Install: https://github.com/hadolint/hadolint#install"
        echo ""
    fi
fi

# =====================================================
# 3. Markdown Linting (Built-in)
# =====================================================

# Load central version pinning
if [ -f .github/versions.env ]; then
    while IFS='=' read -r key value; do
        # Skip comments and empty lines
        [[ "$key" =~ ^#.*$ ]] && continue
        [[ -z "$key" ]] && continue
        # Remove whitespace and export
        key=$(echo "$key" | xargs)
        value=$(echo "$value" | xargs)
        export "${key}=${value}"
    done < .github/versions.env
fi

# Check if any markdown files are being committed
MARKDOWN_FILES_CHANGED=$(git diff --cached --name-only --diff-filter=ACM | grep '\.md$' | grep -v 'untracked-notes/' || true)

if [ -n "$MARKDOWN_FILES_CHANGED" ]; then
    echo "üìù Linting markdown files..."
    echo ""

    # Check if markdownlint-cli is installed
    if command -v markdownlint &> /dev/null; then
        MARKDOWNLINT_FAILED=0

        # Lint all staged markdown files at once
        if ! echo "$MARKDOWN_FILES_CHANGED" | xargs markdownlint --config .markdownlint.json; then
            MARKDOWNLINT_FAILED=1
        fi

        if [ $MARKDOWNLINT_FAILED -eq 1 ]; then
            echo ""
            echo "‚ùå Markdown linting failed!"
            echo ""
            echo "Fix the errors above before committing."
            echo ""
            echo "Common fixes:"
            echo "  - MD060: Ensure table separators match cell style (compact: | --- |)"
            echo ""
            echo "To bypass this check (NOT RECOMMENDED):"
            echo "  git commit --no-verify"
            exit 1
        fi

        echo ""
        echo "‚úÖ Markdown linting passed!"
        echo ""
    else
        echo "‚ö†Ô∏è  WARNING: markdownlint not installed - skipping markdown linting"
        echo "   Install: npm install -g markdownlint-cli@${MARKDOWNLINT_CLI_VERSION:-latest}"
        echo ""
    fi
fi

# =====================================================
# All Validations Passed
# =====================================================

exit 0
