#!/bin/bash
# =====================================================
# Pre-Commit Hook: Validation
# =====================================================
#
# This hook:
# 1. Validates Dockerfiles with hadolint (if available)
# 2. Regenerates traceability matrices if spec/ files changed
# 3. Validates all requirements are properly formatted
# 4. Validates all requirement IDs are unique
# 5. Validates all "Implements" references exist
#
# To install this hook:
#   git config core.hooksPath .githooks
#
# To install hadolint (recommended):
#   Ubuntu/Debian: sudo apt-get install hadolint
#   macOS: brew install hadolint
#   Manual: wget -O /usr/local/bin/hadolint https://github.com/hadolint/hadolint/releases/latest/download/hadolint-Linux-x86_64 && chmod +x /usr/local/bin/hadolint
#
# To bypass this hook (NOT RECOMMENDED):
#   git commit --no-verify
#
# =====================================================

set -e

# =====================================================
# 1. Dockerfile Linting
# =====================================================

# Check if any Dockerfiles are being committed
DOCKERFILES_CHANGED=$(git diff --cached --name-only --diff-filter=ACM | grep -E '(Dockerfile|\.dockerfile)$' || true)

if [ -n "$DOCKERFILES_CHANGED" ]; then
    echo "üê≥ Linting Dockerfiles..."
    echo ""

    # Check if hadolint is installed
    if command -v hadolint &> /dev/null; then
        HADOLINT_FAILED=0

        while IFS= read -r dockerfile; do
            echo "  Checking: $dockerfile"
            if ! hadolint "$dockerfile"; then
                HADOLINT_FAILED=1
            fi
        done <<< "$DOCKERFILES_CHANGED"

        if [ $HADOLINT_FAILED -eq 1 ]; then
            echo ""
            echo "‚ùå Dockerfile linting failed!"
            echo ""
            echo "Fix the errors above before committing."
            echo "See https://github.com/hadolint/hadolint for rules."
            echo ""
            echo "To bypass this check (NOT RECOMMENDED):"
            echo "  git commit --no-verify"
            exit 1
        fi

        echo ""
        echo "‚úÖ Dockerfile linting passed!"
        echo ""
    else
        echo "‚ö†Ô∏è  WARNING: hadolint not installed - skipping Dockerfile linting"
        echo "   Install: https://github.com/hadolint/hadolint#install"
        echo ""
    fi
fi

# =====================================================
# 2. Traceability Matrix Regeneration
# =====================================================

# Check if any spec/ files are being committed
SPEC_FILES_CHANGED=$(git diff --cached --name-only --diff-filter=ACM | grep '^spec/.*\.md$' || true)

if [ -n "$SPEC_FILES_CHANGED" ]; then
    echo "üìä Regenerating traceability matrices (spec files changed)..."
    echo ""

    # Check if generation script exists
    if [ ! -f "tools/requirements/generate_traceability.py" ]; then
        echo "‚ùå ERROR: Generation script not found: tools/requirements/generate_traceability.py"
        exit 1
    fi

    # Regenerate both markdown and HTML matrices
    python3 tools/requirements/generate_traceability.py --format markdown
    python3 tools/requirements/generate_traceability.py --format html

    # Stage the updated matrices (ignore errors if they're gitignored)
    git add traceability_matrix.md traceability_matrix.html 2>/dev/null || true

    echo ""
    echo "‚úÖ Traceability matrices regenerated"
    echo ""
fi

# =====================================================
# 3. Requirement Traceability Validation
# =====================================================

echo "üîç Running requirement traceability validation..."
echo ""

# Check if validation script exists
if [ ! -f "tools/requirements/validate_requirements.py" ]; then
    echo "‚ùå ERROR: Validation script not found: tools/requirements/validate_requirements.py"
    exit 1
fi

# Run validation
if python3 tools/requirements/validate_requirements.py; then
    echo ""
    echo "‚úÖ Requirement validation passed!"
    exit 0
else
    echo ""
    echo "‚ùå Requirement validation failed!"
    echo ""
    echo "Fix the errors above before committing."
    echo "See spec/requirements-format.md for format specification."
    echo ""
    echo "To bypass this check (NOT RECOMMENDED):"
    echo "  git commit --no-verify"
    exit 1
fi
