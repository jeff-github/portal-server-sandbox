#!/bin/bash
# =====================================================
# Pre-Commit Hook: Requirement Traceability Validation
# =====================================================
#
# This hook:
# 1. Regenerates traceability matrices if spec/ files changed
# 2. Validates all requirements are properly formatted
# 3. Validates all requirement IDs are unique
# 4. Validates all "Implements" references exist
#
# To install this hook:
#   git config core.hooksPath .githooks
#
# To bypass this hook (NOT RECOMMENDED):
#   git commit --no-verify
#
# =====================================================

set -e

# Check if any spec/ files are being committed
SPEC_FILES_CHANGED=$(git diff --cached --name-only --diff-filter=ACM | grep '^spec/.*\.md$' || true)

if [ -n "$SPEC_FILES_CHANGED" ]; then
    echo "üìä Regenerating traceability matrices (spec files changed)..."
    echo ""

    # Check if generation script exists
    if [ ! -f "tools/requirements/generate_traceability.py" ]; then
        echo "‚ùå ERROR: Generation script not found: tools/requirements/generate_traceability.py"
        exit 1
    fi

    # Regenerate both markdown and HTML matrices
    python3 tools/requirements/generate_traceability.py --format markdown
    python3 tools/requirements/generate_traceability.py --format html

    # Stage the updated matrices
    git add traceability_matrix.md traceability_matrix.html

    echo ""
    echo "‚úÖ Traceability matrices regenerated and staged"
    echo ""
fi

echo "üîç Running requirement traceability validation..."
echo ""

# Check if validation script exists
if [ ! -f "tools/requirements/validate_requirements.py" ]; then
    echo "‚ùå ERROR: Validation script not found: tools/requirements/validate_requirements.py"
    exit 1
fi

# Run validation
if python3 tools/requirements/validate_requirements.py; then
    echo ""
    echo "‚úÖ Requirement validation passed!"
    exit 0
else
    echo ""
    echo "‚ùå Requirement validation failed!"
    echo ""
    echo "Fix the errors above before committing."
    echo "See spec/requirements-format.md for format specification."
    echo ""
    echo "To bypass this check (NOT RECOMMENDED):"
    echo "  git commit --no-verify"
    exit 1
fi
