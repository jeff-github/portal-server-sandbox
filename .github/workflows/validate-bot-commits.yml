# IMPLEMENTS REQUIREMENTS:
#   REQ-o00013: Requirements Format Validation
#   REQ-p00020: System Validation and Traceability
#   REQ-o00079: Commit and PR Traceability Enforcement (assertion D: bot commit scope validation)

name: Validate Bot Commits

# Run on every push to main (including bot commits)
on:
  push:
    branches:
      - main

permissions:
  contents: read

jobs:
  validate-bot-commits:
    name: Ensure Bot Only Modifies INDEX.md
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 2  # Need at least 2 commits to compare

      - name: Check if commit was made by bot
        id: check_bot
        run: |
          AUTHOR_EMAIL=$(git log -1 --format='%ae')
          COMMIT_MESSAGE=$(git log -1 --format='%s')

          echo "Author: $AUTHOR_EMAIL"
          echo "Message: $COMMIT_MESSAGE"

          # Check if this is a bot commit (github-actions bot or starts with "Bot:")
          if [[ "$AUTHOR_EMAIL" == "github-actions[bot]@users.noreply.github.com" ]] || [[ "$COMMIT_MESSAGE" == Bot:* ]]; then
            echo "is_bot=true" >> $GITHUB_OUTPUT
            echo "::notice::This commit was made by a bot - will validate file changes"
          else
            echo "is_bot=false" >> $GITHUB_OUTPUT
            echo "::notice::This commit was not made by a bot - skipping validation"
          fi

      - name: Validate bot modified only allowed files
        if: steps.check_bot.outputs.is_bot == 'true'
        run: |
          echo "::group::Validating Bot Commit"

          COMMIT_MESSAGE=$(git log -1 --format='%s')

          # Get list of changed files in the last commit
          CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD)

          echo "Files changed in this commit:"
          echo "$CHANGED_FILES"
          echo ""

          # Check if any files were changed
          if [ -z "$CHANGED_FILES" ]; then
            echo "::error::Bot commit changed no files. This is unexpected."
            exit 1
          fi

          # Determine allowed file patterns based on bot type
          VALID=true

          if [[ "$COMMIT_MESSAGE" == *"bump build numbers"* ]]; then
            # Version bump bot: only pubspec.yaml files allowed
            echo "Bot type: version-bump (allowed: */pubspec.yaml)"
            while IFS= read -r file; do
              if [[ "$file" != */pubspec.yaml ]]; then
                echo "::error::  ❌ Not allowed: $file"
                VALID=false
              fi
            done <<< "$CHANGED_FILES"
          elif [[ "$COMMIT_MESSAGE" == *"Claim"* ]] || [[ "$COMMIT_MESSAGE" == *"INDEX"* ]]; then
            # Requirement claim bot: only spec/INDEX.md allowed
            echo "Bot type: requirement-claim (allowed: spec/INDEX.md)"
            if [ "$CHANGED_FILES" != "spec/INDEX.md" ]; then
              VALID=false
              echo "$CHANGED_FILES" | while read -r file; do
                echo "::error::  ❌ Not allowed: $file"
              done
            fi
          else
            # Unknown bot type: only spec/INDEX.md allowed (default)
            echo "Bot type: unknown (default allowed: spec/INDEX.md)"
            if [ "$CHANGED_FILES" != "spec/INDEX.md" ]; then
              VALID=false
              echo "$CHANGED_FILES" | while read -r file; do
                echo "::error::  ❌ Not allowed: $file"
              done
            fi
          fi

          if [ "$VALID" = false ]; then
            echo "::error::❌ SECURITY VIOLATION: Bot commit modified files outside its allowed scope"
            echo "::error::"
            echo "::error::Each bot type has a specific set of files it may modify."
            echo "::error::This prevents accidental or malicious use of bypass tokens to circumvent branch protection."
            exit 1
          fi

          echo "✅ Bot commit validation passed"
          echo "::endgroup::"

      - name: Summary
        if: always()
        run: |
          if [ "${{ steps.check_bot.outputs.is_bot }}" = "true" ]; then
            if [ "${{ job.status }}" = "success" ]; then
              echo "✅ Bot commit validation: PASSED" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "Bot correctly modified only \`spec/INDEX.md\`" >> $GITHUB_STEP_SUMMARY
            else
              echo "❌ Bot commit validation: FAILED" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "**SECURITY VIOLATION**: Bot modified files other than \`spec/INDEX.md\`" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "ℹ️ Not a bot commit - validation skipped" >> $GITHUB_STEP_SUMMARY
          fi
