# IMPLEMENTS REQUIREMENTS:
#   REQ-d00002: Requirements validation tool
#   REQ-o00052: CI/CD Pipeline for Requirement Traceability
#   REQ-d00018: Git Hook Implementation
#   REQ-o00017: Version Control Workflow (commit message validation)

name: PR Validation - Requirements & Traceability

on:
  pull_request:
    branches:
      - main
      - develop
      - 'feature/**'
      - 'release/**'
    types: [opened, synchronize, reopened]
  push:
    branches:
      - main
      - develop

permissions:
  contents: read
  pull-requests: write
  checks: write

jobs:
  # Detect what changed to skip irrelevant tests
  changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    outputs:
      spec: ${{ steps.filter.outputs.spec }}
      code: ${{ steps.filter.outputs.code }}
      database: ${{ steps.filter.outputs.database }}
      python: ${{ steps.filter.outputs.python }}
      workflows: ${{ steps.filter.outputs.workflows }}
    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            spec:
              - 'spec/**'
            code:
              - 'packages/**'
              - 'apps/**'
            database:
              - 'database/**'
            python:
              - 'tools/**/*.py'
            workflows:
              - '.github/workflows/**'

  # Validate commit messages have required CUR-XXX and REQ-XXX references
  validate-commit-messages:
    name: Validate Commit Messages (CUR + REQ)
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    timeout-minutes: 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for commit traversal

      - name: Validate PR commit messages
        id: validate
        run: |
          set -euo pipefail
          echo "::group::Validating Commit Messages"

          # Get all commits in this PR
          BASE_SHA="${{ github.event.pull_request.base.sha }}"
          HEAD_SHA="${{ github.event.pull_request.head.sha }}"

          echo "Checking commits from $BASE_SHA to $HEAD_SHA"
          echo ""

          # Get commit messages (exclude merge commits)
          COMMITS=$(git log --no-merges --format='%H|%s' "$BASE_SHA".."$HEAD_SHA")

          if [ -z "$COMMITS" ]; then
            echo "No commits found in PR"
            echo "::endgroup::"
            exit 0
          fi

          INVALID_COMMITS=()
          VALID_COUNT=0

          while IFS='|' read -r sha subject; do
            # Get full commit message
            FULL_MSG=$(git log -1 --format='%B' "$sha")

            # Check for CUR-XXX reference
            HAS_CUR=false
            if echo "$FULL_MSG" | grep -qE '\[?CUR-[0-9]+\]?'; then
              HAS_CUR=true
            fi

            # Check for REQ-XXX reference (format: REQ-{p|o|d}NNNNN)
            HAS_REQ=false
            if echo "$FULL_MSG" | grep -qE 'REQ-[pdo][0-9]{5}'; then
              HAS_REQ=true
            fi

            # Check validity
            if [ "$HAS_CUR" = "true" ] && [ "$HAS_REQ" = "true" ]; then
              echo "‚úÖ ${sha:0:7}: $subject"
              VALID_COUNT=$((VALID_COUNT + 1))
            else
              ERRORS=""
              if [ "$HAS_CUR" = "false" ]; then
                ERRORS="missing CUR-XXX"
              fi
              if [ "$HAS_REQ" = "false" ]; then
                if [ -n "$ERRORS" ]; then
                  ERRORS="$ERRORS, missing REQ-XXX"
                else
                  ERRORS="missing REQ-XXX"
                fi
              fi
              echo "‚ùå ${sha:0:7}: $subject ($ERRORS)"
              INVALID_COMMITS+=("$sha|$subject|$ERRORS")
            fi
          done <<< "$COMMITS"

          echo ""
          echo "::endgroup::"

          # Report results
          if [ ${#INVALID_COMMITS[@]} -gt 0 ]; then
            echo ""
            echo "::error::Found ${#INVALID_COMMITS[@]} commit(s) without required references"
            echo ""
            echo "‚ùå COMMIT MESSAGE VALIDATION FAILED"
            echo ""
            echo "The following commits are missing required references:"
            echo ""
            for commit in "${INVALID_COMMITS[@]}"; do
              IFS='|' read -r sha subject errors <<< "$commit"
              echo "  ‚Ä¢ ${sha:0:7}: $subject"
              echo "    ‚îî‚îÄ‚îÄ $errors"
            done
            echo ""
            echo "Required format:"
            echo "  [CUR-XXX] Subject line describing the change"
            echo ""
            echo "  Implements: REQ-{type}{number}"
            echo ""
            echo "Where:"
            echo "  CUR-XXX: Linear ticket number (e.g., CUR-399)"
            echo "  REQ type: p (PRD), o (Ops), d (Dev)"
            echo "  REQ number: 5 digits (e.g., REQ-d00018)"
            echo ""
            echo "To fix: Use 'git rebase -i' to edit commit messages"
            echo ""
            exit 1
          else
            echo "‚úÖ All $VALID_COUNT commit(s) have valid CUR-XXX and REQ-XXX references"
          fi

  validate-requirements:
    name: Validate Requirements Format & Traceability
    needs: changes
    if: needs.changes.outputs.spec == 'true' || needs.changes.outputs.workflows == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for accurate change detection

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python3 -m pip install --upgrade pip
          # Note: No additional packages needed - validation uses stdlib only
          # If requirements needed in future: pip install -r tools/requirements/requirements.txt

      - name: Validate requirement format and IDs
        id: validate
        run: |
          echo "::group::Requirement Validation"
          python3 tools/requirements/validate_requirements.py
          RESULT=$?
          echo "::endgroup::"

          if [ $RESULT -ne 0 ]; then
            echo "::error::Requirement validation failed. See details above."
            exit 1
          fi

          echo "‚úÖ Requirement validation passed"

      # Phase 4: Multi-sponsor traceability matrix generation
      # Generates combined (all sponsors) + per-sponsor reports
      # Output structure: build-reports/{combined|sponsor-name}/traceability/

      - name: Generate combined traceability matrix (Markdown)
        if: success()
        run: |
          echo "::group::Generate Combined Traceability Matrix (Markdown)"
          python3 tools/requirements/generate_traceability.py \
            --mode combined \
            --format markdown \
            --output-dir build-reports/combined/traceability
          echo "::endgroup::"

      - name: Generate combined traceability matrix (HTML)
        if: success()
        run: |
          echo "::group::Generate Combined Traceability Matrix (HTML)"
          python3 tools/requirements/generate_traceability.py \
            --mode combined \
            --format html \
            --output-dir build-reports/combined/traceability
          echo "::endgroup::"

      - name: Generate per-sponsor traceability matrices
        if: success()
        run: |
          echo "::group::Generate Sponsor-Specific Traceability Matrices"
          # Get sponsor list from Doppler/environment
          # TODO: Pull from Doppler when available, hardcoded for now
          SPONSORS="callisto titan"
          for sponsor in $SPONSORS; do
            echo "Generating traceability for sponsor: $sponsor"
            python3 tools/requirements/generate_traceability.py \
              --mode sponsor \
              --sponsor $sponsor \
              --format markdown \
              --output-dir build-reports/$sponsor/traceability
            python3 tools/requirements/generate_traceability.py \
              --mode sponsor \
              --sponsor $sponsor \
              --format html \
              --output-dir build-reports/$sponsor/traceability
          done
          echo "::endgroup::"

      - name: Validate INDEX.md accuracy
        if: success()
        run: |
          echo "::group::INDEX.md Validation"
          python3 tools/requirements/validate_index.py
          RESULT=$?
          echo "::endgroup::"

          if [ $RESULT -ne 0 ]; then
            echo "::error::INDEX.md validation failed. See details above."
            exit 1
          fi

          echo "‚úÖ INDEX.md validation passed"

      - name: Upload build reports as artifacts
        if: success()  # Only upload if generation succeeded
        uses: actions/upload-artifact@v4
        with:
          name: build-reports-${{ github.sha }}
          path: build-reports/
          retention-days: 90
          if-no-files-found: error  # Fail if files missing (they're required)

      - name: Check for changed spec files
        id: check-changes
        run: |
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            CHANGED_SPECS=$(git diff --name-only ${{ github.event.pull_request.base.sha }} ${{ github.sha }} | grep '^spec/.*\.md$' || true)
            if [ -n "$CHANGED_SPECS" ]; then
              echo "spec_changed=true" >> $GITHUB_OUTPUT
              echo "Changed spec files:"
              echo "$CHANGED_SPECS"
            else
              echo "spec_changed=false" >> $GITHUB_OUTPUT
            fi
          fi

      - name: Comment on PR with validation results
        if: github.event_name == 'pull_request' && steps.check-changes.outputs.spec_changed == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            let comment = '## ‚úÖ Requirements Validation Passed\n\n';
            comment += 'All requirements have been validated successfully.\n\n';

            // Read combined traceability matrix summary (required for all PRs)
            try {
              const matrix = fs.readFileSync('build-reports/combined/traceability/traceability_matrix.md', 'utf8');
              const lines = matrix.split('\n');

              // Extract summary stats
              const summaryStart = lines.findIndex(l => l.includes('## Summary'));
              if (summaryStart >= 0) {
                const summaryLines = lines.slice(summaryStart, summaryStart + 20);
                comment += '### Combined Traceability Summary\n\n';
                comment += summaryLines.join('\n');
              } else {
                throw new Error('Summary section not found in traceability matrix');
              }
            } catch (err) {
              console.error('Traceability matrix error:', err);
              core.setFailed(`Failed to read traceability matrix: ${err.message}`);
              throw err;  // Fail the workflow
            }

            comment += '\n\nüìä [View full traceability matrix in artifacts](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})';

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

  validate-code-headers:
    name: Validate Code Implementation Headers
    needs: changes
    if: needs.changes.outputs.code == 'true' || needs.changes.outputs.database == 'true' || needs.changes.outputs.workflows == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check implementation files have requirement headers
        run: |
          set -euo pipefail
          echo "::group::Checking Implementation Headers"

          MISSING_HEADERS=()

          # Check SQL files in database directory
          if [ -d "database" ]; then
            shopt -s nullglob
            SQL_FILES=(database/**/*.sql)
            shopt -u nullglob

            for file in "${SQL_FILES[@]}"; do
              # Skip tests and migrations
              if [[ "$file" =~ /tests/ ]] || [[ "$file" =~ /migrations/ ]]; then
                continue
              fi

              if [ -f "$file" ] && ! grep -q "IMPLEMENTS REQUIREMENTS:" "$file"; then
                MISSING_HEADERS+=("$file")
              fi
            done
            echo "::notice::Checked ${#SQL_FILES[@]} SQL files in database/"
          else
            echo "::notice::database/ directory not found, skipping SQL validation"
          fi

          # Check Dart files in packages directory
          if [ -d "packages" ]; then
            shopt -s nullglob
            DART_FILES=(packages/**/*.dart)
            shopt -u nullglob

            for file in "${DART_FILES[@]}"; do
              if [ "$(basename "$file")" != "main.dart" ] && ! grep -q "IMPLEMENTS REQUIREMENTS:" "$file"; then
                MISSING_HEADERS+=("$file")
              fi
            done
            echo "::notice::Checked ${#DART_FILES[@]} Dart files in packages/"
          else
            echo "::notice::packages/ directory not found, skipping Dart validation"
          fi

          # Check Dart files in apps directory
          if [ -d "apps" ]; then
            shopt -s nullglob
            APP_FILES=(apps/**/*.dart)
            shopt -u nullglob

            for file in "${APP_FILES[@]}"; do
              if [ "$(basename "$file")" != "main.dart" ] && ! grep -q "IMPLEMENTS REQUIREMENTS:" "$file"; then
                MISSING_HEADERS+=("$file")
              fi
            done
            echo "::notice::Checked ${#APP_FILES[@]} Dart files in apps/"
          else
            echo "::notice::apps/ directory not found, skipping Dart validation"
          fi

          echo "::endgroup::"

          # Determine branch to decide enforcement level
          BRANCH="${{ github.base_ref }}"
          ENFORCE_HEADERS=false

          if [[ "$BRANCH" == "main" ]] || [[ "$BRANCH" == "staging" ]] || [[ "$BRANCH" == "production" ]]; then
            ENFORCE_HEADERS=true
          fi

          if [ ${#MISSING_HEADERS[@]} -gt 0 ]; then
            if [ "$ENFORCE_HEADERS" = "true" ]; then
              echo "::error::The following implementation files are missing requirement headers:"
              for file in "${MISSING_HEADERS[@]}"; do
                echo "::error file=$file::Missing IMPLEMENTS REQUIREMENTS header"
              done
              echo ""
              echo "‚ùå Implementation headers are REQUIRED for $BRANCH branch."
              echo "See spec/requirements-format.md for the correct format."
              exit 1
            else
              echo "::warning::The following implementation files are missing requirement headers:"
              for file in "${MISSING_HEADERS[@]}"; do
                echo "::warning file=$file::Missing IMPLEMENTS REQUIREMENTS header"
              done
              echo ""
              echo "‚ÑπÔ∏è  Note: This is a warning for feature branches. Headers will be required when merging to main/staging/production."
              echo "See spec/requirements-format.md for the correct format."
            fi
          else
            echo "‚úÖ All implementation files have requirement headers"
          fi

  validate-migrations:
    name: Validate Database Migration Headers
    needs: changes
    if: needs.changes.outputs.database == 'true' || needs.changes.outputs.workflows == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate migration file headers
        run: |
          echo "::group::Validating Migration Headers"

          INVALID_MIGRATIONS=()

          for file in database/migrations/*.sql; do
            if [ -f "$file" ]; then
              # Check for required header components
              if ! grep -q "^-- Migration:" "$file" || \
                 ! grep -q "^-- Date:" "$file" || \
                 ! grep -q "^-- Description:" "$file"; then
                INVALID_MIGRATIONS+=("$file")
              fi
            fi
          done

          echo "::endgroup::"

          if [ ${#INVALID_MIGRATIONS[@]} -gt 0 ]; then
            echo "::error::The following migration files have invalid headers:"
            for file in "${INVALID_MIGRATIONS[@]}"; do
              echo "::error file=$file::Missing required migration header fields"
            done
            echo ""
            echo "See database/migrations/README.md for the correct format."
            exit 1
          else
            echo "‚úÖ All migration files have proper headers"
          fi

  security-check:
    name: Security - Check for Secrets
    needs: changes
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for gitleaks

      - name: Install gitleaks
        env:
          GITLEAKS_VERSION: '8.29.0'  # Version from .github/versions.env
        run: |
          set -euo pipefail
          echo "::group::Installing gitleaks v${GITLEAKS_VERSION}"

          # Download with retry for network resilience
          for i in {1..3}; do
            if wget -q https://github.com/gitleaks/gitleaks/releases/download/v${GITLEAKS_VERSION}/gitleaks_${GITLEAKS_VERSION}_linux_x64.tar.gz; then
              break
            fi
            echo "Download attempt $i failed, retrying..."
            sleep 5
          done

          tar -xzf gitleaks_${GITLEAKS_VERSION}_linux_x64.tar.gz
          sudo mv gitleaks /usr/local/bin/
          rm gitleaks_${GITLEAKS_VERSION}_linux_x64.tar.gz
          gitleaks version
          echo "::endgroup::"

      - name: Scan for secrets with gitleaks
        run: |
          echo "::group::Scanning for secrets with gitleaks"

          # Run gitleaks detect on the entire repository
          # Uses .gitleaks.toml configuration
          if gitleaks detect --verbose --no-banner --redact --log-level info; then
            echo "‚úÖ No secrets detected by gitleaks"
            GITLEAKS_PASSED=true
          else
            echo "::error::Gitleaks detected secrets in the repository"
            GITLEAKS_PASSED=false
          fi

          echo "::endgroup::"

          # Store result for later
          echo "GITLEAKS_PASSED=$GITLEAKS_PASSED" >> $GITHUB_ENV

      - name: Check gitleaks results
        run: |
          if [ "$GITLEAKS_PASSED" = "false" ]; then
            echo "::error::Gitleaks detected secrets in the repository"
            echo "::error::Review the gitleaks output above for details"
            echo "::error::Remove all secrets from the codebase before merging"
            echo "::error::Use environment variables or Doppler for secret management"
            exit 1
          else
            echo "‚úÖ No secrets detected by gitleaks"
          fi

  fda-compliance-check:
    name: FDA Compliance - Audit Trail Verification
    needs: changes
    if: needs.changes.outputs.database == 'true' || needs.changes.outputs.spec == 'true' || needs.changes.outputs.workflows == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Verify audit trail requirements
        run: |
          echo "::group::FDA 21 CFR Part 11 Compliance Check"

          COMPLIANCE_ISSUES=()

          # Check that event sourcing requirements exist
          if ! grep -q "REQ-p00004" spec/prd-database.md 2>/dev/null; then
            COMPLIANCE_ISSUES+=("Event sourcing requirement REQ-p00004 not found")
          fi

          # Check that audit trail implementation exists
          if [ ! -f "database/triggers.sql" ]; then
            COMPLIANCE_ISSUES+=("Audit trail triggers not found")
          fi

          # Check that RLS policies exist
          if [ ! -f "database/rls_policies.sql" ]; then
            COMPLIANCE_ISSUES+=("Row-level security policies not found")
          fi

          echo "::endgroup::"

          if [ ${#COMPLIANCE_ISSUES[@]} -gt 0 ]; then
            echo "::error::FDA compliance issues detected:"
            for issue in "${COMPLIANCE_ISSUES[@]}"; do
              echo "::error::$issue"
            done
            exit 1
          else
            echo "‚úÖ FDA compliance checks passed"
          fi

  test-git-hooks:
    name: Test Git Hooks
    needs: changes
    if: needs.changes.outputs.workflows == 'true' || github.event_name == 'push'
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          echo "::group::Installing dependencies"
          sudo apt-get update -qq
          sudo apt-get install -y jq
          echo "::endgroup::"

      - name: Run plugin structure tests
        run: |
          echo "::group::Plugin Structure Tests"
          cd tools/anspar-cc-plugins/plugins/workflow/tests
          ./test-plugin.sh
          echo "::endgroup::"

      - name: Run git hook tests
        id: hook-tests
        run: |
          echo "::group::Git Hook Integration Tests"
          cd tools/anspar-cc-plugins/plugins/workflow/tests

          # Capture test output to parse counts
          TEST_OUTPUT=$(./test-hooks.sh 2>&1)
          RESULT=$?

          # Display output
          echo "$TEST_OUTPUT"
          echo "::endgroup::"

          # Parse test counts from output
          TESTS_PASSED=$(echo "$TEST_OUTPUT" | grep -oP 'Passed: \K\d+' || echo "0")
          TESTS_FAILED=$(echo "$TEST_OUTPUT" | grep -oP 'Failed: \K\d+' || echo "0")
          TESTS_TOTAL=$((TESTS_PASSED + TESTS_FAILED))

          # Export for summary step
          echo "passed=$TESTS_PASSED" >> $GITHUB_OUTPUT
          echo "failed=$TESTS_FAILED" >> $GITHUB_OUTPUT
          echo "total=$TESTS_TOTAL" >> $GITHUB_OUTPUT

          if [ $RESULT -ne 0 ]; then
            echo "::error::Git hook tests failed. See details above."
            exit 1
          fi

          echo "‚úÖ All git hook tests passed ($TESTS_PASSED/$TESTS_TOTAL)"

      - name: Upload test results
        if: always()
        run: |
          # Get test counts from previous step
          PASSED="${{ steps.hook-tests.outputs.passed }}"
          FAILED="${{ steps.hook-tests.outputs.failed }}"
          TOTAL="${{ steps.hook-tests.outputs.total }}"

          echo "## Git Hook Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.hook-tests.outcome }}" = "success" ]; then
            echo "‚úÖ All tests passed ($PASSED/$TOTAL)" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå Tests failed: $PASSED passed, $FAILED failed (Total: $TOTAL)" >> $GITHUB_STEP_SUMMARY
          fi

  # Pre-PR compliance check for requirement changes
  # Uses unified script that works locally and in CI
  compliance-check:
    name: Requirement Compliance Check
    needs: changes
    if: needs.changes.outputs.spec == 'true' || needs.changes.outputs.code == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Run compliance check
        id: compliance
        env:
          # Optional: Enable AI analysis if API key available
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          echo "::group::Running Pre-PR Compliance Check"

          # Run the unified script (same script used locally)
          cd tools/anspar-cc-plugins/plugins/simple-requirements/scripts

          # Check if AI analysis should be enabled
          ANALYSIS_FLAG=""
          if [ -n "$ANTHROPIC_API_KEY" ]; then
            echo "AI analysis enabled (ANTHROPIC_API_KEY present)"
            ANALYSIS_FLAG="--with-analysis"
          else
            echo "AI analysis disabled (no ANTHROPIC_API_KEY)"
          fi

          python3 pre-pr-compliance-check.py \
            --github-action \
            $ANALYSIS_FLAG

          RESULT=$?
          echo "::endgroup::"

          exit $RESULT

      - name: Comment on PR with compliance results
        if: github.event_name == 'pull_request' && always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');

            // Read the summary that was written by the script
            const summaryPath = process.env.GITHUB_STEP_SUMMARY;
            let summary = '';
            try {
              summary = fs.readFileSync(summaryPath, 'utf8');
            } catch (err) {
              summary = '## Compliance Check\n\nNo compliance issues detected.';
            }

            // Only comment if there are issues or if explicitly requested
            if (summary.includes('Changed Requirements') ||
                summary.includes('Outdated Implementations') ||
                summary.includes('Non-Compliant')) {

              // Find and update existing comment, or create new one
              const { data: comments } = await github.rest.issues.listComments({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number
              });

              const botComment = comments.find(c =>
                c.user.type === 'Bot' &&
                c.body.includes('Pre-PR Compliance Check')
              );

              const body = summary + '\n\n---\n*This comment is auto-generated by the compliance check workflow.*';

              if (botComment) {
                await github.rest.issues.updateComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  comment_id: botComment.id,
                  body: body
                });
              } else {
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: context.issue.number,
                  body: body
                });
              }
            }

  summary:
    name: Validation Summary
    runs-on: ubuntu-latest
    needs: [changes, validate-commit-messages, validate-requirements, validate-code-headers, validate-migrations, security-check, fda-compliance-check, test-git-hooks, compliance-check]
    if: always()

    steps:
      - name: Check all validations passed
        run: |
          echo "## Validation Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Show what changed
          echo "### Changed Files" >> $GITHUB_STEP_SUMMARY
          echo "- Spec: ${{ needs.changes.outputs.spec == 'true' && '‚úì' || '‚Äî' }}" >> $GITHUB_STEP_SUMMARY
          echo "- Code: ${{ needs.changes.outputs.code == 'true' && '‚úì' || '‚Äî' }}" >> $GITHUB_STEP_SUMMARY
          echo "- Database: ${{ needs.changes.outputs.database == 'true' && '‚úì' || '‚Äî' }}" >> $GITHUB_STEP_SUMMARY
          echo "- Python: ${{ needs.changes.outputs.python == 'true' && '‚úì' || '‚Äî' }}" >> $GITHUB_STEP_SUMMARY
          echo "- Workflows: ${{ needs.changes.outputs.workflows == 'true' && '‚úì' || '‚Äî' }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Show test results
          echo "### Test Results" >> $GITHUB_STEP_SUMMARY

          # Commit messages (CUR + REQ)
          if [ "${{ needs.validate-commit-messages.result }}" = "success" ]; then
            echo "‚úÖ Commit messages (CUR + REQ): PASSED" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.validate-commit-messages.result }}" = "skipped" ]; then
            echo "‚è≠Ô∏è Commit messages: SKIPPED (not a PR)" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå Commit messages (CUR + REQ): FAILED" >> $GITHUB_STEP_SUMMARY
          fi

          # Requirements
          if [ "${{ needs.validate-requirements.result }}" = "success" ]; then
            echo "‚úÖ Requirements validation: PASSED" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.validate-requirements.result }}" = "skipped" ]; then
            echo "‚è≠Ô∏è Requirements validation: SKIPPED (no spec changes)" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå Requirements validation: FAILED" >> $GITHUB_STEP_SUMMARY
          fi

          # Code headers
          if [ "${{ needs.validate-code-headers.result }}" = "success" ]; then
            echo "‚úÖ Code headers: PASSED" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.validate-code-headers.result }}" = "skipped" ]; then
            echo "‚è≠Ô∏è Code headers: SKIPPED (no code changes)" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ö†Ô∏è Code headers: WARNING" >> $GITHUB_STEP_SUMMARY
          fi

          # Migrations
          if [ "${{ needs.validate-migrations.result }}" = "success" ]; then
            echo "‚úÖ Migration headers: PASSED" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.validate-migrations.result }}" = "skipped" ]; then
            echo "‚è≠Ô∏è Migration headers: SKIPPED (no database changes)" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå Migration headers: FAILED" >> $GITHUB_STEP_SUMMARY
          fi

          # Security - always runs
          if [ "${{ needs.security-check.result }}" = "success" ]; then
            echo "‚úÖ Security check: PASSED" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå Security check: FAILED" >> $GITHUB_STEP_SUMMARY
          fi

          # FDA compliance
          if [ "${{ needs.fda-compliance-check.result }}" = "success" ]; then
            echo "‚úÖ FDA compliance: PASSED" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.fda-compliance-check.result }}" = "skipped" ]; then
            echo "‚è≠Ô∏è FDA compliance: SKIPPED (no relevant changes)" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå FDA compliance: FAILED" >> $GITHUB_STEP_SUMMARY
          fi

          # Git hooks
          if [ "${{ needs.test-git-hooks.result }}" = "success" ]; then
            echo "‚úÖ Git hook tests: PASSED" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.test-git-hooks.result }}" = "skipped" ]; then
            echo "‚è≠Ô∏è Git hook tests: SKIPPED (no workflow changes)" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå Git hook tests: FAILED" >> $GITHUB_STEP_SUMMARY
          fi

          # Compliance check
          if [ "${{ needs.compliance-check.result }}" = "success" ]; then
            echo "‚úÖ Compliance check: PASSED" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.compliance-check.result }}" = "skipped" ]; then
            echo "‚è≠Ô∏è Compliance check: SKIPPED (no spec/code changes)" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ö†Ô∏è Compliance check: REVIEW NEEDED" >> $GITHUB_STEP_SUMMARY
          fi

          # Overall result - only check jobs that ran
          echo "" >> $GITHUB_STEP_SUMMARY
          FAILED=false

          if [ "${{ needs.validate-commit-messages.result }}" = "failure" ] || \
             [ "${{ needs.validate-requirements.result }}" = "failure" ] || \
             [ "${{ needs.security-check.result }}" = "failure" ] || \
             [ "${{ needs.fda-compliance-check.result }}" = "failure" ] || \
             [ "${{ needs.test-git-hooks.result }}" = "failure" ] || \
             [ "${{ needs.validate-migrations.result }}" = "failure" ]; then
            FAILED=true
          fi

          if [ "$FAILED" = "false" ]; then
            echo "üéâ All validations passed!" >> $GITHUB_STEP_SUMMARY
            exit 0
          else
            echo "‚ö†Ô∏è Some validations failed. Please review the errors above." >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
