# IMPLEMENTS REQUIREMENTS:
#   REQ-d00002: Requirements validation tool
#   REQ-o00052: CI/CD Pipeline for Requirement Traceability
#   REQ-d00018: Git Hook Implementation

name: PR Validation - Requirements & Traceability

on:
  pull_request:
    branches:
      - main
      - develop
      - 'feature/**'
      - 'release/**'
    types: [opened, synchronize, reopened]
  push:
    branches:
      - main
      - develop

permissions:
  contents: read
  pull-requests: write
  checks: write

jobs:
  validate-requirements:
    name: Validate Requirements Format & Traceability
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for accurate change detection

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python3 -m pip install --upgrade pip
          # Note: No additional packages needed - validation uses stdlib only
          # If requirements needed in future: pip install -r tools/requirements/requirements.txt

      - name: Validate requirement format and IDs
        id: validate
        run: |
          echo "::group::Requirement Validation"
          python3 tools/requirements/validate_requirements.py
          RESULT=$?
          echo "::endgroup::"

          if [ $RESULT -ne 0 ]; then
            echo "::error::Requirement validation failed. See details above."
            exit 1
          fi

          echo "âœ… Requirement validation passed"

      # Phase 4: Multi-sponsor traceability matrix generation
      # Generates combined (all sponsors) + per-sponsor reports
      # Output structure: build-reports/{combined|sponsor-name}/traceability/

      - name: Generate combined traceability matrix (Markdown)
        if: success()
        run: |
          echo "::group::Generate Combined Traceability Matrix (Markdown)"
          python3 tools/requirements/generate_traceability.py \
            --mode combined \
            --format markdown \
            --output-dir build-reports/combined/traceability
          echo "::endgroup::"

      - name: Generate combined traceability matrix (HTML)
        if: success()
        run: |
          echo "::group::Generate Combined Traceability Matrix (HTML)"
          python3 tools/requirements/generate_traceability.py \
            --mode combined \
            --format html \
            --output-dir build-reports/combined/traceability
          echo "::endgroup::"

      - name: Generate per-sponsor traceability matrices
        if: success()
        run: |
          echo "::group::Generate Sponsor-Specific Traceability Matrices"
          # Get sponsor list from Doppler/environment
          # TODO: Pull from Doppler when available, hardcoded for now
          SPONSORS="callisto titan"
          for sponsor in $SPONSORS; do
            echo "Generating traceability for sponsor: $sponsor"
            python3 tools/requirements/generate_traceability.py \
              --mode sponsor \
              --sponsor $sponsor \
              --format markdown \
              --output-dir build-reports/$sponsor/traceability
            python3 tools/requirements/generate_traceability.py \
              --mode sponsor \
              --sponsor $sponsor \
              --format html \
              --output-dir build-reports/$sponsor/traceability
          done
          echo "::endgroup::"

      - name: Validate INDEX.md accuracy
        if: success()
        run: |
          echo "::group::INDEX.md Validation"
          python3 tools/requirements/validate_index.py
          RESULT=$?
          echo "::endgroup::"

          if [ $RESULT -ne 0 ]; then
            echo "::error::INDEX.md validation failed. See details above."
            exit 1
          fi

          echo "âœ… INDEX.md validation passed"

      - name: Upload build reports as artifacts
        if: success()  # Only upload if generation succeeded
        uses: actions/upload-artifact@v4
        with:
          name: build-reports-${{ github.sha }}
          path: build-reports/
          retention-days: 90
          if-no-files-found: error  # Fail if files missing (they're required)

      - name: Check for changed spec files
        id: check-changes
        run: |
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            CHANGED_SPECS=$(git diff --name-only ${{ github.event.pull_request.base.sha }} ${{ github.sha }} | grep '^spec/.*\.md$' || true)
            if [ -n "$CHANGED_SPECS" ]; then
              echo "spec_changed=true" >> $GITHUB_OUTPUT
              echo "Changed spec files:"
              echo "$CHANGED_SPECS"
            else
              echo "spec_changed=false" >> $GITHUB_OUTPUT
            fi
          fi

      - name: Comment on PR with validation results
        if: github.event_name == 'pull_request' && steps.check-changes.outputs.spec_changed == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            let comment = '## âœ… Requirements Validation Passed\n\n';
            comment += 'All requirements have been validated successfully.\n\n';

            // Read combined traceability matrix summary (required for all PRs)
            try {
              const matrix = fs.readFileSync('build-reports/combined/traceability/traceability_matrix.md', 'utf8');
              const lines = matrix.split('\n');

              // Extract summary stats
              const summaryStart = lines.findIndex(l => l.includes('## Summary'));
              if (summaryStart >= 0) {
                const summaryLines = lines.slice(summaryStart, summaryStart + 20);
                comment += '### Combined Traceability Summary\n\n';
                comment += summaryLines.join('\n');
              } else {
                throw new Error('Summary section not found in traceability matrix');
              }
            } catch (err) {
              console.error('Traceability matrix error:', err);
              core.setFailed(`Failed to read traceability matrix: ${err.message}`);
              throw err;  // Fail the workflow
            }

            comment += '\n\nðŸ“Š [View full traceability matrix in artifacts](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})';

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

  validate-code-headers:
    name: Validate Code Implementation Headers
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check implementation files have requirement headers
        run: |
          set -euo pipefail
          echo "::group::Checking Implementation Headers"

          MISSING_HEADERS=()

          # Check SQL files in database directory
          if [ -d "database" ]; then
            shopt -s nullglob
            SQL_FILES=(database/**/*.sql)
            shopt -u nullglob

            for file in "${SQL_FILES[@]}"; do
              # Skip tests and migrations
              if [[ "$file" =~ /tests/ ]] || [[ "$file" =~ /migrations/ ]]; then
                continue
              fi

              if [ -f "$file" ] && ! grep -q "IMPLEMENTS REQUIREMENTS:" "$file"; then
                MISSING_HEADERS+=("$file")
              fi
            done
            echo "::notice::Checked ${#SQL_FILES[@]} SQL files in database/"
          else
            echo "::notice::database/ directory not found, skipping SQL validation"
          fi

          # Check Dart files in packages directory
          if [ -d "packages" ]; then
            shopt -s nullglob
            DART_FILES=(packages/**/*.dart)
            shopt -u nullglob

            for file in "${DART_FILES[@]}"; do
              if [ "$(basename "$file")" != "main.dart" ] && ! grep -q "IMPLEMENTS REQUIREMENTS:" "$file"; then
                MISSING_HEADERS+=("$file")
              fi
            done
            echo "::notice::Checked ${#DART_FILES[@]} Dart files in packages/"
          else
            echo "::notice::packages/ directory not found, skipping Dart validation"
          fi

          # Check Dart files in apps directory
          if [ -d "apps" ]; then
            shopt -s nullglob
            APP_FILES=(apps/**/*.dart)
            shopt -u nullglob

            for file in "${APP_FILES[@]}"; do
              if [ "$(basename "$file")" != "main.dart" ] && ! grep -q "IMPLEMENTS REQUIREMENTS:" "$file"; then
                MISSING_HEADERS+=("$file")
              fi
            done
            echo "::notice::Checked ${#APP_FILES[@]} Dart files in apps/"
          else
            echo "::notice::apps/ directory not found, skipping Dart validation"
          fi

          echo "::endgroup::"

          # Determine branch to decide enforcement level
          BRANCH="${{ github.base_ref }}"
          ENFORCE_HEADERS=false

          if [[ "$BRANCH" == "main" ]] || [[ "$BRANCH" == "staging" ]] || [[ "$BRANCH" == "production" ]]; then
            ENFORCE_HEADERS=true
          fi

          if [ ${#MISSING_HEADERS[@]} -gt 0 ]; then
            if [ "$ENFORCE_HEADERS" = "true" ]; then
              echo "::error::The following implementation files are missing requirement headers:"
              for file in "${MISSING_HEADERS[@]}"; do
                echo "::error file=$file::Missing IMPLEMENTS REQUIREMENTS header"
              done
              echo ""
              echo "âŒ Implementation headers are REQUIRED for $BRANCH branch."
              echo "See spec/requirements-format.md for the correct format."
              exit 1
            else
              echo "::warning::The following implementation files are missing requirement headers:"
              for file in "${MISSING_HEADERS[@]}"; do
                echo "::warning file=$file::Missing IMPLEMENTS REQUIREMENTS header"
              done
              echo ""
              echo "â„¹ï¸  Note: This is a warning for feature branches. Headers will be required when merging to main/staging/production."
              echo "See spec/requirements-format.md for the correct format."
            fi
          else
            echo "âœ… All implementation files have requirement headers"
          fi

  validate-migrations:
    name: Validate Database Migration Headers
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Need full history to check changed files

      - name: Check if migrations were changed in this PR
        id: check-migrations
        run: |
          echo "::group::Checking if migrations were modified"

          # Check if this is a PR or a push
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            BASE_SHA="${{ github.event.pull_request.base.sha }}"
            HEAD_SHA="${{ github.sha }}"

            # Get list of changed files
            CHANGED_FILES=$(git diff --name-only $BASE_SHA $HEAD_SHA)

            # Check if any migration files were changed
            if echo "$CHANGED_FILES" | grep -q "^database/migrations/.*\.sql$"; then
              echo "migrations_changed=true" >> $GITHUB_OUTPUT
              echo "âœ“ Migration files were modified in this PR"
            else
              echo "migrations_changed=false" >> $GITHUB_OUTPUT
              echo "â„¹ï¸  No migration files were modified in this PR"
            fi
          else
            # For push events, assume we should check all migrations
            echo "migrations_changed=true" >> $GITHUB_OUTPUT
            echo "â„¹ï¸  Push event - will validate all existing migrations"
          fi

          echo "::endgroup::"

      - name: Validate migration file headers
        if: steps.check-migrations.outputs.migrations_changed == 'true'
        run: |
          echo "::group::Validating Migration Headers"

          INVALID_MIGRATIONS=()

          for file in database/migrations/*.sql; do
            if [ -f "$file" ]; then
              # Check for required header components
              if ! grep -q "^-- Migration:" "$file" || \
                 ! grep -q "^-- Date:" "$file" || \
                 ! grep -q "^-- Description:" "$file"; then
                INVALID_MIGRATIONS+=("$file")
              fi
            fi
          done

          echo "::endgroup::"

          if [ ${#INVALID_MIGRATIONS[@]} -gt 0 ]; then
            echo "::error::The following migration files have invalid headers:"
            for file in "${INVALID_MIGRATIONS[@]}"; do
              echo "::error file=$file::Missing required migration header fields"
            done
            echo ""
            echo "See database/migrations/README.md for the correct format."
            exit 1
          else
            echo "âœ… All migration files have proper headers"
          fi

      - name: Report no migrations to validate
        if: steps.check-migrations.outputs.migrations_changed == 'false'
        run: |
          echo "::notice::No migration files were modified in this PR"
          echo "âœ… Migration validation: PASSED (no migrations to validate)"

  security-check:
    name: Security - Check for Secrets
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for gitleaks

      - name: Install gitleaks
        env:
          GITLEAKS_VERSION: '8.29.0'  # Version from .github/versions.env
        run: |
          set -euo pipefail
          echo "::group::Installing gitleaks v${GITLEAKS_VERSION}"

          # Download with retry for network resilience
          for i in {1..3}; do
            if wget -q https://github.com/gitleaks/gitleaks/releases/download/v${GITLEAKS_VERSION}/gitleaks_${GITLEAKS_VERSION}_linux_x64.tar.gz; then
              break
            fi
            echo "Download attempt $i failed, retrying..."
            sleep 5
          done

          tar -xzf gitleaks_${GITLEAKS_VERSION}_linux_x64.tar.gz
          sudo mv gitleaks /usr/local/bin/
          rm gitleaks_${GITLEAKS_VERSION}_linux_x64.tar.gz
          gitleaks version
          echo "::endgroup::"

      - name: Scan for secrets with gitleaks
        run: |
          echo "::group::Scanning for secrets with gitleaks"

          # Run gitleaks detect on the entire repository
          # Uses .gitleaks.toml configuration
          if gitleaks detect --verbose --no-banner --redact --log-level info; then
            echo "âœ… No secrets detected by gitleaks"
            GITLEAKS_PASSED=true
          else
            echo "::error::Gitleaks detected secrets in the repository"
            GITLEAKS_PASSED=false
          fi

          echo "::endgroup::"

          # Store result for later
          echo "GITLEAKS_PASSED=$GITLEAKS_PASSED" >> $GITHUB_ENV

      - name: Check gitleaks results
        run: |
          if [ "$GITLEAKS_PASSED" = "false" ]; then
            echo "::error::Gitleaks detected secrets in the repository"
            echo "::error::Review the gitleaks output above for details"
            echo "::error::Remove all secrets from the codebase before merging"
            echo "::error::Use environment variables or Doppler for secret management"
            exit 1
          else
            echo "âœ… No secrets detected by gitleaks"
          fi

  fda-compliance-check:
    name: FDA Compliance - Audit Trail Verification
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Verify audit trail requirements
        run: |
          echo "::group::FDA 21 CFR Part 11 Compliance Check"

          COMPLIANCE_ISSUES=()

          # Check that event sourcing requirements exist
          if ! grep -q "REQ-p00004" spec/prd-database.md 2>/dev/null; then
            COMPLIANCE_ISSUES+=("Event sourcing requirement REQ-p00004 not found")
          fi

          # Check that audit trail implementation exists
          if [ ! -f "database/triggers.sql" ]; then
            COMPLIANCE_ISSUES+=("Audit trail triggers not found")
          fi

          # Check that RLS policies exist
          if [ ! -f "database/rls_policies.sql" ]; then
            COMPLIANCE_ISSUES+=("Row-level security policies not found")
          fi

          echo "::endgroup::"

          if [ ${#COMPLIANCE_ISSUES[@]} -gt 0 ]; then
            echo "::error::FDA compliance issues detected:"
            for issue in "${COMPLIANCE_ISSUES[@]}"; do
              echo "::error::$issue"
            done
            exit 1
          else
            echo "âœ… FDA compliance checks passed"
          fi

  test-git-hooks:
    name: Test Git Hooks
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          echo "::group::Installing dependencies"
          sudo apt-get update -qq
          sudo apt-get install -y jq
          echo "::endgroup::"

      - name: Run plugin structure tests
        run: |
          echo "::group::Plugin Structure Tests"
          cd tools/anspar-cc-plugins/plugins/workflow/tests
          ./test-plugin.sh
          echo "::endgroup::"

      - name: Run git hook tests
        id: hook-tests
        run: |
          echo "::group::Git Hook Integration Tests"
          cd tools/anspar-cc-plugins/plugins/workflow/tests

          # Capture test output to parse counts
          TEST_OUTPUT=$(./test-hooks.sh 2>&1)
          RESULT=$?

          # Display output
          echo "$TEST_OUTPUT"
          echo "::endgroup::"

          # Parse test counts from output
          TESTS_PASSED=$(echo "$TEST_OUTPUT" | grep -oP 'Passed: \K\d+' || echo "0")
          TESTS_FAILED=$(echo "$TEST_OUTPUT" | grep -oP 'Failed: \K\d+' || echo "0")
          TESTS_TOTAL=$((TESTS_PASSED + TESTS_FAILED))

          # Export for summary step
          echo "passed=$TESTS_PASSED" >> $GITHUB_OUTPUT
          echo "failed=$TESTS_FAILED" >> $GITHUB_OUTPUT
          echo "total=$TESTS_TOTAL" >> $GITHUB_OUTPUT

          if [ $RESULT -ne 0 ]; then
            echo "::error::Git hook tests failed. See details above."
            exit 1
          fi

          echo "âœ… All git hook tests passed ($TESTS_PASSED/$TESTS_TOTAL)"

      - name: Upload test results
        if: always()
        run: |
          # Get test counts from previous step
          PASSED="${{ steps.hook-tests.outputs.passed }}"
          FAILED="${{ steps.hook-tests.outputs.failed }}"
          TOTAL="${{ steps.hook-tests.outputs.total }}"

          echo "## Git Hook Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.hook-tests.outcome }}" = "success" ]; then
            echo "âœ… All tests passed ($PASSED/$TOTAL)" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Tests failed: $PASSED passed, $FAILED failed (Total: $TOTAL)" >> $GITHUB_STEP_SUMMARY
          fi

  summary:
    name: Validation Summary
    runs-on: ubuntu-latest
    needs: [validate-requirements, validate-code-headers, validate-migrations, security-check, fda-compliance-check, test-git-hooks]
    if: always()

    steps:
      - name: Check all validations passed
        run: |
          echo "## Validation Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.validate-requirements.result }}" = "success" ]; then
            echo "âœ… Requirements validation: PASSED" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Requirements validation: FAILED" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ needs.validate-code-headers.result }}" = "success" ]; then
            echo "âœ… Code headers validation: PASSED" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸  Code headers validation: WARNING" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ needs.validate-migrations.result }}" = "success" ]; then
            echo "âœ… Migration headers validation: PASSED" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Migration headers validation: FAILED" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ needs.security-check.result }}" = "success" ]; then
            echo "âœ… Security check: PASSED" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Security check: FAILED" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ needs.fda-compliance-check.result }}" = "success" ]; then
            echo "âœ… FDA compliance check: PASSED" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ FDA compliance check: FAILED" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ needs.test-git-hooks.result }}" = "success" ]; then
            echo "âœ… Git hook tests: PASSED" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Git hook tests: FAILED" >> $GITHUB_STEP_SUMMARY
          fi

          # Overall result
          if [ "${{ needs.validate-requirements.result }}" = "success" ] && \
             [ "${{ needs.security-check.result }}" = "success" ] && \
             [ "${{ needs.fda-compliance-check.result }}" = "success" ] && \
             [ "${{ needs.test-git-hooks.result }}" = "success" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "ðŸŽ‰ All critical validations passed!" >> $GITHUB_STEP_SUMMARY
            exit 0
          else
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âš ï¸  Some validations failed. Please review the errors above." >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
