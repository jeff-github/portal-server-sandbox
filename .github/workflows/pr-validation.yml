# IMPLEMENTS REQUIREMENTS:
#   REQ-d00002: Requirements validation tool
#   REQ-o00052: CI/CD Pipeline for Requirement Traceability

name: PR Validation - Requirements & Traceability

on:
  pull_request:
    branches:
      - main
      - develop
      - 'feature/**'
      - 'release/**'
    types: [opened, synchronize, reopened]
  push:
    branches:
      - main
      - develop

permissions:
  contents: read
  pull-requests: write
  checks: write

jobs:
  validate-requirements:
    name: Validate Requirements Format & Traceability
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for accurate change detection

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python3 -m pip install --upgrade pip
          # Note: No additional packages needed - validation uses stdlib only
          # If requirements needed in future: pip install -r tools/requirements/requirements.txt

      - name: Validate requirement format and IDs
        id: validate
        run: |
          echo "::group::Requirement Validation"
          python3 tools/requirements/validate_requirements.py
          RESULT=$?
          echo "::endgroup::"

          if [ $RESULT -ne 0 ]; then
            echo "::error::Requirement validation failed. See details above."
            exit 1
          fi

          echo "âœ… Requirement validation passed"

      - name: Generate traceability matrix (Markdown)
        if: success()
        run: |
          echo "::group::Generate Traceability Matrix (Markdown)"
          python3 tools/requirements/generate_traceability.py --format markdown
          echo "::endgroup::"

      - name: Generate traceability matrix (HTML)
        if: success()
        run: |
          echo "::group::Generate Traceability Matrix (HTML)"
          python3 tools/requirements/generate_traceability.py --format html
          echo "::endgroup::"

      - name: Validate INDEX.md accuracy
        if: success()
        run: |
          echo "::group::INDEX.md Validation"
          python3 tools/requirements/validate_index.py
          RESULT=$?
          echo "::endgroup::"

          if [ $RESULT -ne 0 ]; then
            echo "::error::INDEX.md validation failed. See details above."
            exit 1
          fi

          echo "âœ… INDEX.md validation passed"

      - name: Upload traceability matrix as artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: traceability-matrix-${{ github.sha }}
          path: |
            traceability_matrix.md
            traceability_matrix.html
          retention-days: 90
          if-no-files-found: warn

      - name: Check for changed spec files
        id: check-changes
        run: |
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            CHANGED_SPECS=$(git diff --name-only ${{ github.event.pull_request.base.sha }} ${{ github.sha }} | grep '^spec/.*\.md$' || true)
            if [ -n "$CHANGED_SPECS" ]; then
              echo "spec_changed=true" >> $GITHUB_OUTPUT
              echo "Changed spec files:"
              echo "$CHANGED_SPECS"
            else
              echo "spec_changed=false" >> $GITHUB_OUTPUT
            fi
          fi

      - name: Comment on PR with validation results
        if: github.event_name == 'pull_request' && steps.check-changes.outputs.spec_changed == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            let comment = '## âœ… Requirements Validation Passed\n\n';
            comment += 'All requirements have been validated successfully.\n\n';

            // Try to read traceability matrix summary
            try {
              const matrix = fs.readFileSync('traceability_matrix.md', 'utf8');
              const lines = matrix.split('\n');

              // Extract summary stats
              const summaryStart = lines.findIndex(l => l.includes('## Summary'));
              if (summaryStart >= 0) {
                const summaryLines = lines.slice(summaryStart, summaryStart + 20);
                comment += '### Traceability Summary\n\n';
                comment += summaryLines.join('\n');
              }
            } catch (err) {
              console.log('Could not read traceability matrix:', err);
            }

            comment += '\n\nðŸ“Š [View full traceability matrix in artifacts](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})';

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

  validate-code-headers:
    name: Validate Code Implementation Headers
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check implementation files have requirement headers
        run: |
          echo "::group::Checking Implementation Headers"

          MISSING_HEADERS=()

          # Check SQL files
          for file in $(find database -name "*.sql" -not -path "*/tests/*" -not -path "*/migrations/*" 2>/dev/null || true); do
            if [ -f "$file" ]; then
              if ! grep -q "IMPLEMENTS REQUIREMENTS:" "$file"; then
                MISSING_HEADERS+=("$file")
              fi
            fi
          done

          # Check Dart files (when they exist)
          for file in $(find packages apps -name "*.dart" 2>/dev/null || true); do
            if [ -f "$file" ] && [ "$(basename "$file")" != "main.dart" ]; then
              if ! grep -q "IMPLEMENTS REQUIREMENTS:" "$file"; then
                MISSING_HEADERS+=("$file")
              fi
            fi
          done

          echo "::endgroup::"

          if [ ${#MISSING_HEADERS[@]} -gt 0 ]; then
            echo "::warning::The following implementation files are missing requirement headers:"
            for file in "${MISSING_HEADERS[@]}"; do
              echo "::warning file=$file::Missing IMPLEMENTS REQUIREMENTS header"
            done
            echo ""
            echo "â„¹ï¸  Note: This is a warning, not a failure. Please add requirement headers when possible."
            echo "See spec/requirements-format.md for the correct format."
          else
            echo "âœ… All implementation files have requirement headers"
          fi

  validate-migrations:
    name: Validate Database Migration Headers
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Need full history to check changed files

      - name: Check if migrations were changed in this PR
        id: check-migrations
        run: |
          echo "::group::Checking if migrations were modified"

          # Check if this is a PR or a push
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            BASE_SHA="${{ github.event.pull_request.base.sha }}"
            HEAD_SHA="${{ github.sha }}"

            # Get list of changed files
            CHANGED_FILES=$(git diff --name-only $BASE_SHA $HEAD_SHA)

            # Check if any migration files were changed
            if echo "$CHANGED_FILES" | grep -q "^database/migrations/.*\.sql$"; then
              echo "migrations_changed=true" >> $GITHUB_OUTPUT
              echo "âœ“ Migration files were modified in this PR"
            else
              echo "migrations_changed=false" >> $GITHUB_OUTPUT
              echo "â„¹ï¸  No migration files were modified in this PR"
            fi
          else
            # For push events, assume we should check all migrations
            echo "migrations_changed=true" >> $GITHUB_OUTPUT
            echo "â„¹ï¸  Push event - will validate all existing migrations"
          fi

          echo "::endgroup::"

      - name: Validate migration file headers
        if: steps.check-migrations.outputs.migrations_changed == 'true'
        run: |
          echo "::group::Validating Migration Headers"

          INVALID_MIGRATIONS=()

          for file in database/migrations/*.sql; do
            if [ -f "$file" ]; then
              # Check for required header components
              if ! grep -q "^-- Migration:" "$file" || \
                 ! grep -q "^-- Date:" "$file" || \
                 ! grep -q "^-- Description:" "$file"; then
                INVALID_MIGRATIONS+=("$file")
              fi
            fi
          done

          echo "::endgroup::"

          if [ ${#INVALID_MIGRATIONS[@]} -gt 0 ]; then
            echo "::error::The following migration files have invalid headers:"
            for file in "${INVALID_MIGRATIONS[@]}"; do
              echo "::error file=$file::Missing required migration header fields"
            done
            echo ""
            echo "See database/migrations/README.md for the correct format."
            exit 1
          else
            echo "âœ… All migration files have proper headers"
          fi

      - name: Report no migrations to validate
        if: steps.check-migrations.outputs.migrations_changed == 'false'
        run: |
          echo "::notice::No migration files were modified in this PR"
          echo "âœ… Migration validation: PASSED (no migrations to validate)"

  security-check:
    name: Security - Check for Secrets
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for gitleaks

      - name: Install gitleaks
        run: |
          echo "::group::Installing gitleaks"
          wget -q https://github.com/gitleaks/gitleaks/releases/download/v8.18.0/gitleaks_8.18.0_linux_x64.tar.gz
          tar -xzf gitleaks_8.18.0_linux_x64.tar.gz
          sudo mv gitleaks /usr/local/bin/
          rm gitleaks_8.18.0_linux_x64.tar.gz
          gitleaks version
          echo "::endgroup::"

      - name: Scan for secrets with gitleaks
        run: |
          echo "::group::Scanning for secrets with gitleaks"

          # Run gitleaks detect on the entire repository
          # Uses .gitleaks.toml configuration
          if gitleaks detect --verbose --no-banner --redact --log-level info; then
            echo "âœ… No secrets detected by gitleaks"
            GITLEAKS_PASSED=true
          else
            echo "::error::Gitleaks detected secrets in the repository"
            GITLEAKS_PASSED=false
          fi

          echo "::endgroup::"

          # Store result for later
          echo "GITLEAKS_PASSED=$GITLEAKS_PASSED" >> $GITHUB_ENV

      - name: Check gitleaks results
        run: |
          if [ "$GITLEAKS_PASSED" = "false" ]; then
            echo "::error::Gitleaks detected secrets in the repository"
            echo "::error::Review the gitleaks output above for details"
            echo "::error::Remove all secrets from the codebase before merging"
            echo "::error::Use environment variables or Doppler for secret management"
            exit 1
          else
            echo "âœ… No secrets detected by gitleaks"
          fi

  fda-compliance-check:
    name: FDA Compliance - Audit Trail Verification
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Verify audit trail requirements
        run: |
          echo "::group::FDA 21 CFR Part 11 Compliance Check"

          COMPLIANCE_ISSUES=()

          # Check that event sourcing requirements exist
          if ! grep -q "REQ-p00004" spec/prd-database.md 2>/dev/null; then
            COMPLIANCE_ISSUES+=("Event sourcing requirement REQ-p00004 not found")
          fi

          # Check that audit trail implementation exists
          if [ ! -f "database/triggers.sql" ]; then
            COMPLIANCE_ISSUES+=("Audit trail triggers not found")
          fi

          # Check that RLS policies exist
          if [ ! -f "database/rls_policies.sql" ]; then
            COMPLIANCE_ISSUES+=("Row-level security policies not found")
          fi

          echo "::endgroup::"

          if [ ${#COMPLIANCE_ISSUES[@]} -gt 0 ]; then
            echo "::error::FDA compliance issues detected:"
            for issue in "${COMPLIANCE_ISSUES[@]}"; do
              echo "::error::$issue"
            done
            exit 1
          else
            echo "âœ… FDA compliance checks passed"
          fi

  summary:
    name: Validation Summary
    runs-on: ubuntu-latest
    needs: [validate-requirements, validate-code-headers, validate-migrations, security-check, fda-compliance-check]
    if: always()

    steps:
      - name: Check all validations passed
        run: |
          echo "## Validation Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.validate-requirements.result }}" = "success" ]; then
            echo "âœ… Requirements validation: PASSED" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Requirements validation: FAILED" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ needs.validate-code-headers.result }}" = "success" ]; then
            echo "âœ… Code headers validation: PASSED" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸  Code headers validation: WARNING" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ needs.validate-migrations.result }}" = "success" ]; then
            echo "âœ… Migration headers validation: PASSED" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Migration headers validation: FAILED" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ needs.security-check.result }}" = "success" ]; then
            echo "âœ… Security check: PASSED" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Security check: FAILED" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ needs.fda-compliance-check.result }}" = "success" ]; then
            echo "âœ… FDA compliance check: PASSED" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ FDA compliance check: FAILED" >> $GITHUB_STEP_SUMMARY
          fi

          # Overall result
          if [ "${{ needs.validate-requirements.result }}" = "success" ] && \
             [ "${{ needs.security-check.result }}" = "success" ] && \
             [ "${{ needs.fda-compliance-check.result }}" = "success" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "ðŸŽ‰ All critical validations passed!" >> $GITHUB_STEP_SUMMARY
            exit 0
          else
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âš ï¸  Some validations failed. Please review the errors above." >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
