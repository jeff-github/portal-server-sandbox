# IMPLEMENTS REQUIREMENTS:
#   REQ-d00027: Containerized Development Environments
#   REQ-d00029: Cross-Platform Development Support
#   REQ-d00030: CI/CD Integration
#
# GitHub Codespaces Prebuild Workflow
# Builds Dev Container images in advance for faster Codespace launches

name: Codespaces Prebuild

on:
  push:
    branches:
      - main
    paths:
      - '.devcontainer/**'
      - 'tools/dev-env/docker/**'
      - 'tools/dev-env/docker-compose.yml'
  # Disabled for PRs - QA automation workflow builds from source instead
  # pull_request:
  #   branches:
  #     - main
  #   paths:
  #     - '.devcontainer/**'
  #     - 'tools/dev-env/docker/**'
  #     - 'tools/dev-env/docker-compose.yml'
  workflow_dispatch:

jobs:
  prebuild:
    name: Prebuild ${{ matrix.container }} Container
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix:
        container: [dev, qa, ops]

    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Prebuild ${{ matrix.container }} container
        uses: devcontainers/ci@v0.3
        with:
          configFile: .devcontainer/${{ matrix.container }}/devcontainer.json
          push: always
          imageTag: latest,${{ matrix.container }}
          cacheFrom: ghcr.io/${{ github.repository }}/devcontainer-${{ matrix.container }}

  summary:
    name: Prebuild Summary
    runs-on: ubuntu-latest
    needs: [prebuild]
    if: always()
    permissions:
      contents: read

    steps:
      - name: Generate summary
        run: |
          echo "# Codespaces Prebuild Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Branch**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Prebuilt Containers" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Dev container" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ QA container" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Ops container" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Codespaces will now launch in ~30 seconds instead of 2-5 minutes!" >> $GITHUB_STEP_SUMMARY
