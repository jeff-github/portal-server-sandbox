# IMPLEMENTS REQUIREMENTS:
#   REQ-d00027: Containerized Development Environments
#   REQ-d00029: Cross-Platform Development Support
#   REQ-d00030: CI/CD Integration
#
# GitHub Codespaces Prebuild Workflow
# Builds Dev Container images in advance for faster Codespace launches

name: Codespaces Prebuild

on:
  push:
    branches:
      - main
    paths:
      - '.devcontainer/**'
      - 'tools/dev-env/docker/**'
      - 'tools/dev-env/docker-compose.yml'
  # Disabled for PRs - QA automation workflow builds from source instead
  # pull_request:
  #   branches:
  #     - main
  #   paths:
  #     - '.devcontainer/**'
  #     - 'tools/dev-env/docker/**'
  #     - 'tools/dev-env/docker-compose.yml'
  workflow_dispatch:

jobs:
  prebuild-dev:
    name: Prebuild Dev Container
    runs-on: ubuntu-latest

    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Prebuild dev container
        uses: devcontainers/ci@v0.3
        with:
          configFile: .devcontainer/dev/devcontainer.json
          push: always
          imageTag: latest,dev
          cacheFrom: ghcr.io/${{ github.repository }}/devcontainer-dev

  prebuild-qa:
    name: Prebuild QA Container
    runs-on: ubuntu-latest

    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Prebuild QA container
        uses: devcontainers/ci@v0.3
        with:
          configFile: .devcontainer/qa/devcontainer.json
          push: always
          imageTag: latest,qa
          cacheFrom: ghcr.io/${{ github.repository }}/devcontainer-qa

  prebuild-ops:
    name: Prebuild Ops Container
    runs-on: ubuntu-latest

    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Prebuild ops container
        uses: devcontainers/ci@v0.3
        with:
          configFile: .devcontainer/ops/devcontainer.json
          push: always
          imageTag: latest,ops
          cacheFrom: ghcr.io/${{ github.repository }}/devcontainer-ops

  summary:
    name: Prebuild Summary
    runs-on: ubuntu-latest
    needs: [prebuild-dev, prebuild-qa, prebuild-ops]
    if: always()

    steps:
      - name: Generate summary
        run: |
          echo "# Codespaces Prebuild Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Branch**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Prebuilt Containers" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Dev container" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ QA container" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Ops container" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Codespaces will now launch in ~30 seconds instead of 2-5 minutes!" >> $GITHUB_STEP_SUMMARY
