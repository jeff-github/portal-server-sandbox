# IMPLEMENTS REQUIREMENTS:
#   REQ-d00006: Mobile App Build and Release Process
#   REQ-o00052: CI/CD Pipeline for Requirement Traceability

name: Auto-Bump Build Numbers

# Runs on every PR merge to main. Detects which Dart/Flutter projects
# had source changes (including dependencies) and increments the +N
# build number in their pubspec.yaml.

on:
  push:
    branches: [main]

permissions:
  contents: write

jobs:
  bump-build-numbers:
    name: Bump Build Numbers
    runs-on: ubuntu-latest
    # Skip bot commits to avoid infinite loop
    if: "!startsWith(github.event.head_commit.message, 'Bot:')"
    timeout-minutes: 5

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.BOT_BYPASS_MAIN_PROTECTION || github.token }}
          fetch-depth: 2

      - name: Detect changes and bump build numbers
        id: bump
        run: |
          set -euo pipefail

          # Get files changed in the merge commit
          CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD 2>/dev/null || true)

          if [ -z "$CHANGED_FILES" ]; then
            echo "No changed files detected"
            echo "bumped=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          echo "Changed files:"
          echo "$CHANGED_FILES" | head -20
          echo ""

          # =====================================================
          # Project definitions: name|pubspec_path|trigger_paths
          #
          # trigger_paths are space-separated directory prefixes.
          # If ANY changed file starts with a trigger path, the
          # project's build number is bumped.
          #
          # Dependencies are included as trigger paths so that
          # e.g. a change in trial_data_types bumps clinical_diary.
          # =====================================================
          PROJECTS=(
            # Deployable apps
            "clinical_diary|apps/daily-diary/clinical_diary/pubspec.yaml|apps/daily-diary/clinical_diary/ apps/common-dart/trial_data_types/ apps/common-dart/append_only_datastore/ apps/daily-diary/diary_functions/ apps/common-flutter/eq/"
            "portal-ui|apps/sponsor-portal/portal-ui/pubspec.yaml|apps/sponsor-portal/portal-ui/ apps/sponsor-portal/portal_functions/ apps/common-dart/trial_data_types/"
            "diary_server|apps/daily-diary/diary_server/pubspec.yaml|apps/daily-diary/diary_server/ apps/daily-diary/diary_functions/ apps/common-dart/trial_data_types/ database/"
            "portal_server|apps/sponsor-portal/portal_server/pubspec.yaml|apps/sponsor-portal/portal_server/ apps/sponsor-portal/portal_functions/ apps/common-dart/trial_data_types/ database/"
            # Libraries
            "trial_data_types|apps/common-dart/trial_data_types/pubspec.yaml|apps/common-dart/trial_data_types/"
            "append_only_datastore|apps/common-dart/append_only_datastore/pubspec.yaml|apps/common-dart/append_only_datastore/"
            "diary_functions|apps/daily-diary/diary_functions/pubspec.yaml|apps/daily-diary/diary_functions/ apps/common-dart/trial_data_types/"
            "portal_functions|apps/sponsor-portal/portal_functions/pubspec.yaml|apps/sponsor-portal/portal_functions/ apps/common-dart/trial_data_types/"
            "eq|apps/common-flutter/eq/pubspec.yaml|apps/common-flutter/eq/ apps/common-dart/trial_data_types/"
            "rave-integration|apps/edc/rave-integration/pubspec.yaml|apps/edc/rave-integration/"
          )

          BUMPED_LIST=""

          for project_def in "${PROJECTS[@]}"; do
            IFS='|' read -r name pubspec triggers <<< "$project_def"

            # Skip if pubspec doesn't exist
            if [ ! -f "$pubspec" ]; then
              continue
            fi

            # Check if any trigger path matches a changed file
            should_bump=false
            for trigger in $triggers; do
              if echo "$CHANGED_FILES" | grep -q "^${trigger}"; then
                # Exclude pubspec.yaml and pubspec.lock from triggering (avoid circular bumps)
                non_pubspec=$(echo "$CHANGED_FILES" | grep "^${trigger}" | grep -v "pubspec.yaml" | grep -v "pubspec.lock" || true)
                if [ -n "$non_pubspec" ]; then
                  should_bump=true
                  break
                fi
              fi
            done

            if [ "$should_bump" = true ]; then
              # Read current version
              current=$(grep '^version:' "$pubspec" | sed 's/version: //')

              # Parse base version and build number
              base_version=$(echo "$current" | sed 's/+.*//')
              build_num=$(echo "$current" | grep -oP '\+\K[0-9]+' || echo "0")
              if [ -z "$build_num" ]; then build_num=0; fi

              # Increment build number
              new_build=$((build_num + 1))
              new_version="${base_version}+${new_build}"

              # Update pubspec.yaml
              sed -i "s/^version: .*/version: ${new_version}/" "$pubspec"

              echo "  $name: $current -> $new_version"
              BUMPED_LIST="${BUMPED_LIST} ${name}"
            fi
          done

          if [ -z "$BUMPED_LIST" ]; then
            echo "No projects need build number bumps"
            echo "bumped=false" >> "$GITHUB_OUTPUT"
          else
            echo "bumped=true" >> "$GITHUB_OUTPUT"
            echo "projects=${BUMPED_LIST}" >> "$GITHUB_OUTPUT"
          fi

      - name: Commit and push
        if: steps.bump.outputs.bumped == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add '*/pubspec.yaml'
          git commit -m "Bot: bump build numbers for${{ steps.bump.outputs.projects }}"
          git push

      - name: Summary
        if: always()
        run: |
          if [ "${{ steps.bump.outputs.bumped }}" = "true" ]; then
            echo "### Build Numbers Bumped" >> "$GITHUB_STEP_SUMMARY"
            echo "" >> "$GITHUB_STEP_SUMMARY"
            echo "Projects:${{ steps.bump.outputs.projects }}" >> "$GITHUB_STEP_SUMMARY"
          else
            echo "### No Build Number Changes" >> "$GITHUB_STEP_SUMMARY"
            echo "" >> "$GITHUB_STEP_SUMMARY"
            echo "No Dart/Flutter projects had source changes in this commit." >> "$GITHUB_STEP_SUMMARY"
          fi
