# IMPLEMENTS REQUIREMENTS:
#   REQ-d00027: Containerized Development Environments
#   REQ-d00030: CI/CD Integration
#   REQ-d00033: FDA Validation Documentation
#   REQ-d00035: Security and Compliance
#
# Clinical Diary Docker Image Build & Publish
# Builds, signs, and publishes Docker images to GitHub Container Registry

name: Build & Publish Docker Images

on:
  push:
    branches:
      - main
      - 'release/**'
    paths:
      - 'tools/dev-env/docker/**'
      - 'tools/dev-env/docker-compose.yml'
      - '.github/workflows/build-publish-images.yml'
  pull_request:
    paths:
      - 'tools/dev-env/docker/**'
      - 'tools/dev-env/docker-compose.yml'
      - '.github/workflows/build-publish-images.yml'
  workflow_dispatch:
    inputs:
      push_to_registry:
        description: 'Push images to GitHub Container Registry'
        required: false
        default: 'true'
        type: choice
        options:
          - 'true'
          - 'false'

env:
  REGISTRY: ghcr.io
  IMAGE_PREFIX: ${{ github.repository_owner }}/clinical-diary

permissions:
  contents: read
  packages: write
  id-token: write  # For Cosign signing

jobs:
  build-base:
    name: Build Base Image
    runs-on: ubuntu-latest

    outputs:
      image_tag: ${{ steps.meta.outputs.tags }}
      image_digest: ${{ steps.build.outputs.digest }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
          # Use docker driver for PR builds to enable docker load/image sharing between jobs
          # Use docker-container driver (default) for main builds to support provenance/SBOM
          driver: ${{ github.event_name == 'pull_request' && 'docker' || 'docker-container' }}

      - name: Log in to GitHub Container Registry
        if: github.event_name != 'pull_request'
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}-base
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=sha,prefix=sha-
            type=raw,value=latest,enable={{is_default_branch}}

      - name: Build and push base image
        id: build
        uses: docker/build-push-action@v5
        with:
          context: tools/dev-env/docker
          file: tools/dev-env/docker/base.Dockerfile
          push: ${{ github.ref == 'refs/heads/main' || github.event.inputs.push_to_registry == 'true' }}
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          # COHERENT CACHING: GHCR only (no GHA cache)
          # Images in GHCR serve as cache - pull latest before build
          cache-from: type=registry,ref=${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}-base:latest
          cache-to: type=inline
          provenance: true
          sbom: true

      - name: Export local image for downstream jobs
        if: github.event_name == 'pull_request'
        uses: docker/build-push-action@v5
        with:
          context: tools/dev-env/docker
          file: tools/dev-env/docker/base.Dockerfile
          tags: clinical-diary-base:latest
          outputs: type=docker,dest=/tmp/base-image.tar
          cache-from: type=registry,ref=${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}-base:latest

      - name: Upload base image artifact
        if: github.event_name == 'pull_request'
        uses: actions/upload-artifact@v4
        with:
          name: base-image
          path: /tmp/base-image.tar
          retention-days: 1

  build-dev:
    name: Build Dev Image
    runs-on: ubuntu-latest
    needs: build-base

    env:
      BASE_IMAGE_REF: ${{ github.event_name == 'pull_request' && 'clinical-diary-base:latest' || 'ghcr.io/cure-hht/clinical-diary-base:latest' }}

    outputs:
      image_digest: ${{ steps.build.outputs.digest }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
          # Use docker driver for PR builds to enable docker load/image sharing between jobs
          # Use docker-container driver (default) for main builds to support provenance/SBOM
          driver: ${{ github.event_name == 'pull_request' && 'docker' || 'docker-container' }}

      - name: Download base image (PR only)
        if: github.event_name == 'pull_request'
        uses: actions/download-artifact@v4
        with:
          name: base-image
          path: /tmp

      - name: Load base image (PR only)
        if: github.event_name == 'pull_request'
        run: docker load --input /tmp/base-image.tar

      - name: Log in to GitHub Container Registry
        if: github.event_name != 'pull_request'
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}-dev
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=sha,prefix=sha-
            type=raw,value=latest,enable={{is_default_branch}}

      - name: Build and push dev image
        id: build
        uses: docker/build-push-action@v5
        with:
          context: tools/dev-env/docker
          file: tools/dev-env/docker/dev.Dockerfile
          build-args: |
            BASE_IMAGE_REF=${{ env.BASE_IMAGE_REF }}
          push: ${{ github.ref == 'refs/heads/main' || github.event.inputs.push_to_registry == 'true' }}
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=registry,ref=${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}-dev:latest
          cache-to: type=inline
          provenance: true
          sbom: true

      - name: Export local image for downstream jobs
        if: github.event_name == 'pull_request'
        uses: docker/build-push-action@v5
        with:
          context: tools/dev-env/docker
          file: tools/dev-env/docker/dev.Dockerfile
          build-args: |
            BASE_IMAGE_REF=clinical-diary-base:latest
          tags: clinical-diary-dev:latest
          outputs: type=docker,dest=/tmp/dev-image.tar
          cache-from: type=registry,ref=${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}-dev:latest

      - name: Upload dev image artifact
        if: github.event_name == 'pull_request'
        uses: actions/upload-artifact@v4
        with:
          name: dev-image
          path: /tmp/dev-image.tar
          retention-days: 1

  build-qa:
    name: Build QA Image
    runs-on: ubuntu-latest
    needs: [build-base, build-dev]

    env:
      DEV_IMAGE_REF: ${{ github.event_name == 'pull_request' && 'clinical-diary-dev:latest' || 'ghcr.io/cure-hht/clinical-diary-dev:latest' }}

    outputs:
      image_digest: ${{ steps.build.outputs.digest }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
          # Use docker driver for PR builds to enable docker load/image sharing between jobs
          # Use docker-container driver (default) for main builds to support provenance/SBOM
          driver: ${{ github.event_name == 'pull_request' && 'docker' || 'docker-container' }}

      - name: Download base image (PR only)
        if: github.event_name == 'pull_request'
        uses: actions/download-artifact@v4
        with:
          name: base-image
          path: /tmp

      - name: Download dev image (PR only)
        if: github.event_name == 'pull_request'
        uses: actions/download-artifact@v4
        with:
          name: dev-image
          path: /tmp

      - name: Load images (PR only)
        if: github.event_name == 'pull_request'
        run: |
          docker load --input /tmp/base-image.tar
          docker load --input /tmp/dev-image.tar

      - name: Log in to GitHub Container Registry
        if: github.event_name != 'pull_request'
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}-qa
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=sha,prefix=sha-
            type=raw,value=latest,enable={{is_default_branch}}

      - name: Build and push QA image
        id: build
        uses: docker/build-push-action@v5
        with:
          context: tools/dev-env/docker
          file: tools/dev-env/docker/qa.Dockerfile
          build-args: |
            DEV_IMAGE_REF=${{ env.DEV_IMAGE_REF }}
          push: ${{ github.ref == 'refs/heads/main' || github.event.inputs.push_to_registry == 'true' }}
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=registry,ref=${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}-qa:latest
          cache-to: type=inline
          provenance: true
          sbom: true

  build-ops:
    name: Build Ops Image
    runs-on: ubuntu-latest
    needs: build-base

    env:
      BASE_IMAGE_REF: ${{ github.event_name == 'pull_request' && 'clinical-diary-base:latest' || 'ghcr.io/cure-hht/clinical-diary-base:latest' }}

    outputs:
      image_digest: ${{ steps.build.outputs.digest }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
          # Use docker driver for PR builds to enable docker load/image sharing between jobs
          # Use docker-container driver (default) for main builds to support provenance/SBOM
          driver: ${{ github.event_name == 'pull_request' && 'docker' || 'docker-container' }}

      - name: Download base image (PR only)
        if: github.event_name == 'pull_request'
        uses: actions/download-artifact@v4
        with:
          name: base-image
          path: /tmp

      - name: Load base image (PR only)
        if: github.event_name == 'pull_request'
        run: docker load --input /tmp/base-image.tar

      - name: Log in to GitHub Container Registry
        if: github.event_name != 'pull_request'
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}-ops
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=sha,prefix=sha-
            type=raw,value=latest,enable={{is_default_branch}}

      - name: Build and push ops image
        id: build
        uses: docker/build-push-action@v5
        with:
          context: tools/dev-env/docker
          file: tools/dev-env/docker/ops.Dockerfile
          build-args: |
            BASE_IMAGE_REF=${{ env.BASE_IMAGE_REF }}
          push: ${{ github.ref == 'refs/heads/main' || github.event.inputs.push_to_registry == 'true' }}
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=registry,ref=${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}-ops:latest
          cache-to: type=inline
          provenance: true
          sbom: true

  build-mgmt:
    name: Build Management Image
    runs-on: ubuntu-latest
    needs: build-base

    env:
      BASE_IMAGE_REF: ${{ github.event_name == 'pull_request' && 'clinical-diary-base:latest' || 'ghcr.io/cure-hht/clinical-diary-base:latest' }}

    outputs:
      image_digest: ${{ steps.build.outputs.digest }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
          # Use docker driver for PR builds to enable docker load/image sharing between jobs
          # Use docker-container driver (default) for main builds to support provenance/SBOM
          driver: ${{ github.event_name == 'pull_request' && 'docker' || 'docker-container' }}

      - name: Download base image (PR only)
        if: github.event_name == 'pull_request'
        uses: actions/download-artifact@v4
        with:
          name: base-image
          path: /tmp

      - name: Load base image (PR only)
        if: github.event_name == 'pull_request'
        run: docker load --input /tmp/base-image.tar

      - name: Log in to GitHub Container Registry
        if: github.event_name != 'pull_request'
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}-mgmt
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=sha,prefix=sha-
            type=raw,value=latest,enable={{is_default_branch}}

      - name: Build and push management image
        id: build
        uses: docker/build-push-action@v5
        with:
          context: tools/dev-env/docker
          file: tools/dev-env/docker/mgmt.Dockerfile
          build-args: |
            BASE_IMAGE_REF=${{ env.BASE_IMAGE_REF }}
          push: ${{ github.ref == 'refs/heads/main' || github.event.inputs.push_to_registry == 'true' }}
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=registry,ref=${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}-mgmt:latest
          cache-to: type=inline
          provenance: true
          sbom: true

  sign-and-sbom:
    name: Sign Images & Generate SBOMs
    runs-on: ubuntu-latest
    needs: [build-base, build-dev, build-qa, build-ops, build-mgmt]
    if: github.event_name != 'pull_request' && (github.ref == 'refs/heads/main' || github.event.inputs.push_to_registry == 'true')

    steps:
      - name: Install Cosign
        uses: sigstore/cosign-installer@v3

      - name: Install Syft
        uses: anchore/sbom-action/download-syft@v0

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Sign base image
        run: |
          cosign sign --yes \
            ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}-base@${{ needs.build-base.outputs.image_digest }}

      - name: Sign dev image
        run: |
          cosign sign --yes \
            ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}-dev@${{ needs.build-dev.outputs.image_digest }}

      - name: Sign QA image
        run: |
          cosign sign --yes \
            ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}-qa@${{ needs.build-qa.outputs.image_digest }}

      - name: Sign ops image
        run: |
          cosign sign --yes \
            ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}-ops@${{ needs.build-ops.outputs.image_digest }}

      - name: Sign management image
        run: |
          cosign sign --yes \
            ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}-mgmt@${{ needs.build-mgmt.outputs.image_digest }}

      - name: Generate SBOM for base image
        run: |
          syft ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}-base@${{ needs.build-base.outputs.image_digest }} \
            -o spdx-json \
            --file base-sbom.spdx.json

      - name: Generate SBOM for dev image
        run: |
          syft ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}-dev@${{ needs.build-dev.outputs.image_digest }} \
            -o spdx-json \
            --file dev-sbom.spdx.json

      - name: Generate SBOM for QA image
        run: |
          syft ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}-qa@${{ needs.build-qa.outputs.image_digest }} \
            -o spdx-json \
            --file qa-sbom.spdx.json

      - name: Generate SBOM for ops image
        run: |
          syft ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}-ops@${{ needs.build-ops.outputs.image_digest }} \
            -o spdx-json \
            --file ops-sbom.spdx.json

      - name: Generate SBOM for management image
        run: |
          syft ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}-mgmt@${{ needs.build-mgmt.outputs.image_digest }} \
            -o spdx-json \
            --file mgmt-sbom.spdx.json

      - name: Upload SBOMs as artifacts
        uses: actions/upload-artifact@v4
        with:
          name: sboms-${{ github.sha }}
          path: |
            *-sbom.spdx.json
          retention-days: 90

      - name: Attach SBOM attestation to base image
        run: |
          cosign attest --yes \
            --predicate base-sbom.spdx.json \
            --type spdxjson \
            ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}-base@${{ needs.build-base.outputs.image_digest }}

      - name: Attach SBOM attestation to dev image
        run: |
          cosign attest --yes \
            --predicate dev-sbom.spdx.json \
            --type spdxjson \
            ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}-dev@${{ needs.build-dev.outputs.image_digest }}

      - name: Attach SBOM attestation to QA image
        run: |
          cosign attest --yes \
            --predicate qa-sbom.spdx.json \
            --type spdxjson \
            ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}-qa@${{ needs.build-qa.outputs.image_digest }}

      - name: Attach SBOM attestation to ops image
        run: |
          cosign attest --yes \
            --predicate ops-sbom.spdx.json \
            --type spdxjson \
            ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}-ops@${{ needs.build-ops.outputs.image_digest }}

      - name: Attach SBOM attestation to mgmt image
        run: |
          cosign attest --yes \
            --predicate mgmt-sbom.spdx.json \
            --type spdxjson \
            ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}-mgmt@${{ needs.build-mgmt.outputs.image_digest }}

  verify-images:
    name: Verify Image Signatures
    runs-on: ubuntu-latest
    needs: [sign-and-sbom, build-base, build-dev, build-qa, build-ops, build-mgmt]
    if: github.event_name != 'pull_request' && (github.ref == 'refs/heads/main' || github.event.inputs.push_to_registry == 'true')

    steps:
      - name: Install Cosign
        uses: sigstore/cosign-installer@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Verify base image signature
        run: |
          echo "Verifying base image..."
          cosign verify \
            --certificate-identity-regexp="https://github.com/${{ github.repository }}" \
            --certificate-oidc-issuer=https://token.actions.githubusercontent.com \
            ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}-base@${{ needs.build-base.outputs.image_digest }}

      - name: Verify dev image signature
        run: |
          echo "Verifying dev image..."
          cosign verify \
            --certificate-identity-regexp="https://github.com/${{ github.repository }}" \
            --certificate-oidc-issuer=https://token.actions.githubusercontent.com \
            ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}-dev@${{ needs.build-dev.outputs.image_digest }}

      - name: Verify QA image signature
        run: |
          echo "Verifying qa image..."
          cosign verify \
            --certificate-identity-regexp="https://github.com/${{ github.repository }}" \
            --certificate-oidc-issuer=https://token.actions.githubusercontent.com \
            ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}-qa@${{ needs.build-qa.outputs.image_digest }}

      - name: Verify ops image signature
        run: |
          echo "Verifying ops image..."
          cosign verify \
            --certificate-identity-regexp="https://github.com/${{ github.repository }}" \
            --certificate-oidc-issuer=https://token.actions.githubusercontent.com \
            ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}-ops@${{ needs.build-ops.outputs.image_digest }}

      - name: Verify mgmt image signature
        run: |
          echo "Verifying mgmt image..."
          cosign verify \
            --certificate-identity-regexp="https://github.com/${{ github.repository }}" \
            --certificate-oidc-issuer=https://token.actions.githubusercontent.com \
            ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}-mgmt@${{ needs.build-mgmt.outputs.image_digest }}

  summary:
    name: Build Summary
    runs-on: ubuntu-latest
    needs: [build-base, build-dev, build-qa, build-ops, build-mgmt]
    if: always()

    steps:
      - name: Generate summary
        run: |
          echo "# Docker Image Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Event**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Branch**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Images Built" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Base image" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Dev image" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ QA image" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Ops image" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Management image" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ github.event_name }}" != "pull_request" ]; then
            echo "## Published to GHCR" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Images available at: \`${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}-*\`" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "- Image signatures verified with Cosign" >> $GITHUB_STEP_SUMMARY
            echo "- SBOMs generated with Syft" >> $GITHUB_STEP_SUMMARY
          else
            echo "## Build Verification Only" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Pull request builds are not pushed to registry." >> $GITHUB_STEP_SUMMARY
          fi
