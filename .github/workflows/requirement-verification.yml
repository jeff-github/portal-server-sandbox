name: Requirement Verification

on:
  push:
    paths:
      - 'spec/**/*.md'
  pull_request:
    paths:
      - 'spec/**/*.md'

jobs:
  verify-requirements:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for git operations

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Detect changed requirements
        id: detect
        run: |
          set -euo pipefail

          # Run detection script
          if ! python3 tools/anspar-cc-plugins/plugins/simple-requirements/scripts/detect-changes.py \
            --format json > changes.json; then
            echo "âŒ ERROR: detect-changes.py failed" >&2
            exit 1
          fi

          # Parse results using array-based approach (no subshells)
          if ! CHANGED_COUNT=$(jq '.summary.changed_count' changes.json 2>&1); then
            echo "âŒ ERROR: Failed to parse changes.json" >&2
            cat changes.json
            exit 1
          fi

          NEW_COUNT=$(jq '.summary.new_count' changes.json)
          TOTAL=$((CHANGED_COUNT + NEW_COUNT))

          echo "changed_count=$CHANGED_COUNT" >> $GITHUB_OUTPUT
          echo "new_count=$NEW_COUNT" >> $GITHUB_OUTPUT
          echo "total=$TOTAL" >> $GITHUB_OUTPUT

      - name: Scan implementations
        if: steps.detect.outputs.total > 0
        id: scan
        run: |
          set -euo pipefail

          # Determine branch for enforcement level
          BRANCH="${{ github.base_ref || github.ref_name }}"
          echo "Target branch: $BRANCH"

          # Determine enforcement level
          ENFORCE_LEVEL="info"
          if [[ "$BRANCH" == "production" ]] || [[ "$BRANCH" == "staging" ]]; then
            ENFORCE_LEVEL="error"
          elif [[ "$BRANCH" == "main" ]]; then
            ENFORCE_LEVEL="warning"
          fi
          echo "Enforcement level: $ENFORCE_LEVEL"

          # Load requirements into array (no subshells)
          mapfile -t req_ids < <(jq -r '.changed_requirements[].req_id' changes.json)

          # Check if array is empty
          if [ ${#req_ids[@]} -eq 0 ]; then
            echo "â„¹ï¸ No changed requirements found"
            exit 0
          fi

          echo "Found ${#req_ids[@]} changed requirements to scan"

          # Initialize implementations file
          echo "[]" > implementations.json

          # Track failures
          FAILED_REQS=()

          # Process each requirement
          for req_id in "${req_ids[@]}"; do
            echo "Scanning implementations for $req_id..."
            if ! python3 tools/anspar-cc-plugins/plugins/simple-requirements/scripts/scan-implementations.py \
              "$req_id" --format json >> implementations.json 2>&1; then
              echo "âŒ Scan failed for $req_id" >&2
              FAILED_REQS+=("$req_id")
            fi
          done

          # Handle failures based on enforcement level
          if [ ${#FAILED_REQS[@]} -gt 0 ]; then
            echo ""
            echo "Failed to scan ${#FAILED_REQS[@]} requirement(s): ${FAILED_REQS[*]}"

            if [[ "$ENFORCE_LEVEL" == "error" ]]; then
              echo "âŒ ERROR: Implementation scanning failed for $BRANCH branch" >&2
              echo "scan_status=failed" >> $GITHUB_OUTPUT
              exit 1
            elif [[ "$ENFORCE_LEVEL" == "warning" ]]; then
              echo "âš ï¸ WARNING: Implementation scanning failed (not blocking for $BRANCH branch)"
              echo "scan_status=warning" >> $GITHUB_OUTPUT
            else
              echo "â„¹ï¸ INFO: Implementation scanning had issues (informational only for $BRANCH branch)"
              echo "scan_status=info" >> $GITHUB_OUTPUT
            fi
          else
            echo "âœ… All implementations scanned successfully"
            echo "scan_status=success" >> $GITHUB_OUTPUT
          fi

      - name: Generate report
        if: steps.detect.outputs.total > 0
        run: |
          set -euo pipefail

          python3 tools/anspar-cc-plugins/plugins/simple-requirements/scripts/generate-report.py \
            --from-tracking --format markdown --output verification-report.md

      - name: Upload verification report
        if: steps.detect.outputs.total > 0
        uses: actions/upload-artifact@v4
        with:
          name: verification-report
          path: |
            verification-report.md
            changes.json
            implementations.json
          retention-days: 90

      - name: Comment on PR
        if: github.event_name == 'pull_request' && steps.detect.outputs.total > 0
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            let report = 'No report generated';
            try {
              report = fs.readFileSync('verification-report.md', 'utf8');
            } catch (e) {
              report = 'Verification report generation failed or no changes detected.';
            }

            const changedCount = '${{ steps.detect.outputs.changed_count }}';
            const newCount = '${{ steps.detect.outputs.new_count }}';

            const body = `## ðŸ“‹ Requirement Verification

Changed Requirements: ${changedCount}
New Requirements: ${newCount}

<details>
<summary>View Verification Report</summary>

${report}

</details>

**Next Steps:**
1. Review changed requirements
2. Update implementations if needed
3. Run: \`python3 tools/anspar-cc-plugins/plugins/simple-requirements/scripts/mark-verified.py REQ-{id}\`
            `;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });

      - name: Summary
        if: always()
        run: |
          set -euo pipefail

          echo "## Requirement Verification Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Check detection status
          if [ "${{ steps.detect.conclusion }}" == "failure" ]; then
            echo "âŒ **Status**: FAILED" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Detection script failed. Check logs above for details." >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

          # Show requirement counts
          echo "- **Changed**: ${{ steps.detect.outputs.changed_count }}" >> $GITHUB_STEP_SUMMARY
          echo "- **New**: ${{ steps.detect.outputs.new_count }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Total**: ${{ steps.detect.outputs.total }}" >> $GITHUB_STEP_SUMMARY

          # Show scan status
          SCAN_STATUS="${{ steps.scan.outputs.scan_status }}"
          if [ -n "$SCAN_STATUS" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            case "$SCAN_STATUS" in
              success)
                echo "âœ… **Scan Status**: All implementations scanned successfully" >> $GITHUB_STEP_SUMMARY
                ;;
              warning)
                echo "âš ï¸ **Scan Status**: Completed with warnings (not blocking)" >> $GITHUB_STEP_SUMMARY
                ;;
              info)
                echo "â„¹ï¸ **Scan Status**: Informational (see logs for details)" >> $GITHUB_STEP_SUMMARY
                ;;
              failed)
                echo "âŒ **Scan Status**: FAILED - blocking merge" >> $GITHUB_STEP_SUMMARY
                ;;
            esac
          fi

          # Overall status
          if [ "${{ steps.detect.outputs.total }}" -gt 0 ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âœ… Verification completed - see artifacts for details" >> $GITHUB_STEP_SUMMARY
          else
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âœ… No requirement changes detected" >> $GITHUB_STEP_SUMMARY
          fi
