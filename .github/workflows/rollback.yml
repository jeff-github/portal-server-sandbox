# IMPLEMENTS REQUIREMENTS:
#   REQ-o00043: Automated Deployment Pipeline
#   REQ-o00044: Database Migration Automation
#
# Manual Rollback Workflow
# Rolls back application and database to previous known-good state

name: Rollback Deployment

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to rollback'
        required: true
        type: choice
        options:
          - development
          - staging
          - production
      target_version:
        description: 'Target version to rollback to (e.g., v1.2.3)'
        required: true
        type: string
      reason:
        description: 'Reason for rollback'
        required: true
        type: string

jobs:
  rollback:
    name: Rollback ${{ github.event.inputs.environment }}
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment }}

    steps:
      - name: Log rollback initiation
        run: |
          echo "⚠️  ROLLBACK INITIATED"
          echo "Environment: ${{ github.event.inputs.environment }}"
          echo "Target version: ${{ github.event.inputs.target_version }}"
          echo "Reason: ${{ github.event.inputs.reason }}"
          echo "Initiated by: ${{ github.actor }}"

      - name: Capture current production version
        id: current_version
        run: |
          echo "Querying current production version..."

          # Query GitHub Actions API for last successful production deployment
          LAST_DEPLOY=$(gh run list \
            --workflow "deploy-production.yml" \
            --status success \
            --limit 1 \
            --json databaseId,headSha,conclusion \
            --jq '.[0]' || echo '{}')

          CURRENT_SHA=$(echo "$LAST_DEPLOY" | jq -r '.headSha // "INITIAL_DEPLOYMENT"')
          CURRENT_RUN=$(echo "$LAST_DEPLOY" | jq -r '.databaseId // "N/A"')

          echo "current_sha=${CURRENT_SHA}" >> $GITHUB_OUTPUT
          echo "current_run_id=${CURRENT_RUN}" >> $GITHUB_OUTPUT

          if [ "$CURRENT_SHA" = "INITIAL_DEPLOYMENT" ]; then
            echo "⚠️ No previous production deployment found"
          else
            echo "✅ Current production commit: ${CURRENT_SHA}"
            echo "   From deployment run: ${CURRENT_RUN}"
          fi
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Verify target version exists
        run: |
          # Use exact version matching to avoid partial matches
          TARGET_VERSION="${{ github.event.inputs.target_version }}"
          if ! git ls-remote --tags origin | grep -E "refs/tags/${TARGET_VERSION}$"; then
            echo "❌ Target version not found: ${TARGET_VERSION}"
            exit 1
          fi
          echo "✅ Target version verified: ${TARGET_VERSION}"

      - name: Checkout target version
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.target_version }}

      - name: Setup environment
        run: |
          # Setup Node.js
          curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash -
          sudo apt-get install -y nodejs

          # Install Supabase CLI
          # Pinned to v2.54.10 (matches Dockerfile version for consistency)
          # Last updated: 2025-11-11
          wget -qO- https://github.com/supabase/cli/releases/download/v2.54.10/supabase_linux_amd64.tar.gz | tar xzf -
          sudo mv supabase /usr/local/bin/

          npm install

      - name: Load secrets
        uses: dopplerhq/cli-action@v3
        env:
          DOPPLER_TOKEN: ${{ secrets[format('DOPPLER_TOKEN_{0}', github.event.inputs.environment)] }}

      - name: Database rollback
        run: |
          echo "Rolling back database..."

          # Get project ID for environment
          PROJECT_ID=${{ secrets[format('SUPABASE_PROJECT_ID_{0}', github.event.inputs.environment)] }}

          # Link to project
          doppler run -- supabase link --project-ref $PROJECT_ID

          # Execute rollback
          cd database/migrations/rollbacks

          # Find and execute appropriate rollback script
          ROLLBACK_SCRIPT=$(ls -r | grep ${{ github.event.inputs.target_version }} | head -n1)

          if [ -z "$ROLLBACK_SCRIPT" ]; then
            echo "⚠️  No rollback script found for ${{ github.event.inputs.target_version }}"
            echo "Manual intervention may be required"
          else
            echo "Executing rollback script: $ROLLBACK_SCRIPT"
            doppler run -- psql $DATABASE_URL -f $ROLLBACK_SCRIPT
          fi

          echo "✅ Database rollback complete"

      - name: Deploy previous version
        run: |
          echo "Deploying previous application version..."

          PROJECT_ID=${{ secrets[format('SUPABASE_PROJECT_ID_{0}', github.event.inputs.environment)] }}
          doppler run -- supabase functions deploy --project-ref $PROJECT_ID

          echo "✅ Application rollback complete"

      - name: Verify rollback with smoke tests
        run: |
          echo "Verifying rollback with smoke tests..."
          cd tools/testing/smoke-tests
          doppler run -- ./run-smoke-tests.sh ${{ github.event.inputs.environment }}
          echo "✅ Smoke tests passed"

      - name: Record rollback
        if: success()
        run: |
          echo "Recording rollback..."
          ROLLBACK_LOG="rollback-${{ github.event.inputs.environment }}-$(date +%Y%m%d-%H%M%S).json"

          # Create structured JSON audit log (FDA 21 CFR Part 11 compliant)
          cat > $ROLLBACK_LOG <<EOF
          {
            "rollback_timestamp": "$(date -u +"%Y-%m-%dT%H:%M:%SZ")",
            "environment": "${{ github.event.inputs.environment }}",
            "from_commit_sha": "${{ steps.current_version.outputs.current_sha }}",
            "from_deployment_run_id": "${{ steps.current_version.outputs.current_run_id }}",
            "to_version": "${{ github.event.inputs.target_version }}",
            "to_commit_sha": "${{ github.sha }}",
            "reason": "${{ github.event.inputs.reason }}",
            "initiated_by": "${{ github.actor }}",
            "github_run_id": "${{ github.run_id }}",
            "github_run_number": "${{ github.run_number }}",
            "outcome": "success",
            "workflow": "rollback-deployment"
          }
          EOF

          cat $ROLLBACK_LOG

          # For production, upload to S3 for 7-year retention
          if [ "${{ github.event.inputs.environment }}" = "production" ]; then
            echo "Uploading rollback audit log to S3..."

            # Get AWS region and bucket from Doppler (per-sponsor configuration)
            AWS_REGION=$(doppler run -- bash -c 'echo $SPONSOR_AWS_REGION' || echo "eu-west-1")
            AUDIT_BUCKET=$(doppler run -- bash -c 'echo $SPONSOR_AUDIT_LOGS_BUCKET' || echo "hht-diary-audit-logs-callisto-${AWS_REGION}")

            # Upload to S3: rollbacks/YYYY/MM/DD/filename.json
            S3_PATH="s3://${AUDIT_BUCKET}/rollbacks/$(date +%Y/%m/%d)/${ROLLBACK_LOG}"

            if aws s3 cp "$ROLLBACK_LOG" "$S3_PATH" \
              --tagging "environment=production&type=rollback-log&retention-years=7&fda-compliant=true" \
              --metadata "from-sha=${{ steps.current_version.outputs.current_sha }},to-version=${{ github.event.inputs.target_version }},initiator=${{ github.actor }}"; then
              echo "✅ Rollback audit log uploaded to S3: $S3_PATH"
            else
              echo "⚠️ Failed to upload rollback log to S3 - log saved locally"
            fi
          fi

      - name: Notify team
        if: success()
        run: |
          echo "✅ Rollback completed successfully"
          echo "Environment: ${{ github.event.inputs.environment }}"
          echo "Version: ${{ github.event.inputs.target_version }}"
          echo "System restored to known-good state"

      - name: Rollback failed
        if: failure()
        run: |
          echo "❌ ROLLBACK FAILED"
          echo "Environment: ${{ github.event.inputs.environment }}"
          echo "⚠️  MANUAL INTERVENTION REQUIRED"
          echo "Contact Tech Lead immediately"
