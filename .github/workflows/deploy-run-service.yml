---
# IMPLEMENTS REQUIREMENTS:
#   REQ-o00044: GCP Authentication via Workload Identity Federation
#   REQ-o00043: Automated Deployment Pipeline
#   REQ-o00002: Environment-Specific Configuration Management
#   REQ-o00001: Separate GCP Projects Per Sponsor
#   REQ-o00051: Change Control and Audit Trail
#   REQ-d00058: Secrets Management via Doppler
#   REQ-o00070: Data Residency Enforcement
#
# This workflow tests GCP authentication using Workload Identity Federation
# Triggered manually via workflow_dispatch or called from build-portal-server.yml

name: 'Deploy cloud run service'

on:
  workflow_dispatch:
    inputs:
      service-name:
        description: 'Cloud Run service to deploy'
        required: true
        type: choice
        options:
          - diary-service
          - portal-service
      image_path:
        description: 'Full ghcr.io image path (e.g., ghcr.io/cure-hht/portal-server:v1.2.3)'
        required: true
        type: string
      version:
        description: 'Version being deployed (e.g., 1.2.3, abc1234 for main branch)'
        required: false
        type: string
  workflow_call:
    inputs:
      service-name:
        description: 'Cloud Run service to deploy (diary-service or portal-service)'
        required: true
        type: string
      image_path:
        description: 'Full ghcr.io image path (e.g., ghcr.io/cure-hht/portal-server:v1.2.3)'
        required: true
        type: string
      version:
        description: 'Version being deployed (e.g., 1.2.3, abc1234 for main branch)'
        required: false
        type: string
    secrets:
      DOPPLER_TOKEN:
        description: 'Doppler service token for the target environment'
        required: true

env:
  GCP_REPO_PATH: 'europe-west9-docker.pkg.dev/${{ vars.GCP_PROJECT_ID }}/ghcr-remote'

jobs:
  deploy-portal-service:
    runs-on: ubuntu-latest
    permissions:
      contents: 'read'
      id-token: 'write'  # Required to request the OIDC token

    steps:
      - name: 'Validate service-name'
        run: |
          if [[ "${{ inputs.service-name }}" != "diary-service" && "${{ inputs.service-name }}" != "portal-service" ]]; then
            echo "::error::service-name must be 'diary-service' or 'portal-service', got '${{ inputs.service-name }}'"
            exit 1
          fi

      - uses: 'actions/checkout@v4'

      - name: 'Authenticate with Google Cloud'
        id: 'auth'
        uses: 'google-github-actions/auth@v2'
        with:
          workload_identity_provider: projects/${{ vars.GCP_PROJECT_NUMBER }}/locations/global/workloadIdentityPools/github-pool/providers/github-provider
          service_account: '${{ vars.GCP_SA_EMAIL }}'

      - name: 'Translate ghcr.io path to Google Artifact Registry'
        id: translate-path
        run: |
          INPUT_IMAGE="${{ inputs.image_path }}"
          echo "Input image: $INPUT_IMAGE"

          # Extract components from ghcr.io path
          # Format: ghcr.io/org/image:tag or ghcr.io/org/image
          if [[ ! "$INPUT_IMAGE" =~ ^ghcr\.io/ ]]; then
            echo "::error::Image path must start with ghcr.io/"
            exit 1
          fi

          # Remove ghcr.io/ prefix
          IMAGE_PATH="${INPUT_IMAGE#ghcr.io/}"

          # Split into path and tag
          if [[ "$IMAGE_PATH" =~ : ]]; then
            TAG="${IMAGE_PATH##*:}"
            IMAGE_PATH="${IMAGE_PATH%:*}"
          else
            TAG="latest"
          fi

          # Extract org and image name
          ORG="${IMAGE_PATH%%/*}"
          IMAGE_NAME="${IMAGE_PATH#*/}"

          # Map image names if needed (portal-server -> clinical-diary-portal-server)
          case "$IMAGE_NAME" in
            # "portal-server")
            #   MAPPED_IMAGE="clinical-diary-portal-server"
            #   ;;
            *)
              MAPPED_IMAGE="$IMAGE_NAME"
              ;;
          esac

          # Construct GAR path
          GAR_PATH="${{ env.GCP_REPO_PATH }}/${ORG}/${MAPPED_IMAGE}:${TAG}"

          echo "Translated GAR path: $GAR_PATH"
          echo "gar_path=$GAR_PATH" >> $GITHUB_OUTPUT
          echo "image_tag=$TAG" >> $GITHUB_OUTPUT
          echo "image_name=$MAPPED_IMAGE" >> $GITHUB_OUTPUT

      - name: 'Configure Docker for Artifact Registry'
        run: |
          gcloud auth configure-docker europe-west9-docker.pkg.dev --quiet

      - name: 'Validate image exists in Artifact Registry'
        run: |
          GAR_PATH="${{ steps.translate-path.outputs.gar_path }}"
          echo "Validating image: $GAR_PATH"

          gcloud config set project ${{ vars.GCP_PROJECT_ID }}

          # Try to describe the image (validates it exists)
          echo "Checking image metadata..."
          gcloud artifacts docker images describe "$GAR_PATH" --format="table(image_summary.digest,image_summary.fully_qualified_digest,package,tags)" || {
            echo "::warning::Image not found via describe, attempting docker pull..."
            docker pull "$GAR_PATH"
          }

          echo "✅ Image validation successful: $GAR_PATH"

      - name: 'Deploy to Cloud Run'
        run: |
          GAR_PATH="${{ steps.translate-path.outputs.gar_path }}"
          VERSION="${{ inputs.version }}"
          echo "Deploying image to Cloud Run: $GAR_PATH"
          if [ -n "$VERSION" ]; then
            echo "Version: $VERSION"
          fi

          gcloud run services update ${{ inputs.service-name }} \
            --region=europe-west9 \
            --project=${{ vars.GCP_DEPLOY2_PROJECT_ID }} \
            --image="$GAR_PATH" \
            --cpu=2 \
            --memory=4Gi \
            --min-instances=1 \
            --max-instances=2 \
            --add-cloudsql-instances=${{ vars.GCP_DB_CONNECTION_NAME }} \
            --vpc-connector ${{ vars.GCP_SERVERLESS_VPC_CONNECTOR }} \
            --set-env-vars="DOPPLER_TOKEN=${{ secrets.DOPPLER_TOKEN }},ENVIRONMENT=dev"

          echo "✅ Cloud Run deployment successful${VERSION:+ (version: $VERSION)}"

      - name: 'Display authentication info'
        run: |
          echo "GCP Project: ${{ vars.GCP_PROJECT_ID }}"
          gcloud auth list
          gcloud artifacts docker images list ${{ env.GCP_REPO_PATH }} --limit=5
