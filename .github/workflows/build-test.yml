# IMPLEMENTS REQUIREMENTS:
#   REQ-o00052: CI/CD Pipeline for Requirement Traceability (test-requirements-tools job)
#   REQ-o00081: Code Quality and Static Analysis (validate-documentation job)

name: Build and Test

on:
  push:
    branches: [ main, release/** ]
  pull_request:
    branches: [ main ]

jobs:
  test-requirements-tools:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          # Note: No pip cache - only elspais installed, no requirements.txt

      - name: Load version configuration
        id: versions
        run: |
          source .github/versions.env
          echo "elspais_version=${ELSPAIS_VERSION}" >> $GITHUB_OUTPUT

      - name: Install elspais
        run: |
          python3 -m pip install --upgrade pip
          ELSPAIS_VERSION="${{ steps.versions.outputs.elspais_version }}"
          echo "Installing elspais v${ELSPAIS_VERSION}..."
          pip install elspais==${ELSPAIS_VERSION}
          elspais --version

      - name: Validate requirement format and IDs
        run: |
          echo "Testing requirement validation..."
          elspais validate --mode core
          echo "Requirement validation passed"

      # Phase 4: Traceability matrix generation
      # Output: build-reports/combined/traceability/
      # Note: Sponsor-specific traceability now handled in separate sponsor repos

      - name: Generate traceability matrix
        run: |
          echo "Testing traceability matrix generation..."
          mkdir -p build-reports/combined/traceability
          elspais trace --format both --output build-reports/combined/traceability/traceability_matrix
          echo "Traceability matrix generated"

      - name: Upload build reports as artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: build-reports-${{ github.sha }}
          path: build-reports/
          retention-days: 90

  test-linear-cli-tools:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Validate Linear API scripts
        run: |
          echo "ðŸ” Validating Linear API scripts syntax..."
          cd tools/anspar-cc-plugins/plugins/linear-api/scripts
          # Check all JavaScript files for syntax errors
          for file in *.js; do
            if [ -f "$file" ]; then
              node --check "$file" && echo "âœ… $file syntax valid" || exit 1
            fi
          done
          echo "âœ… All Linear API scripts validated"

  validate-documentation:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4

      - name: Load version pinning
        run: |
          # Export all versions from .github/versions.env to GitHub Actions environment
          while IFS='=' read -r key value; do
            # Skip comments and empty lines
            [[ "$key" =~ ^#.*$ ]] && continue
            [[ -z "$key" ]] && continue
            # Remove whitespace and export to GITHUB_ENV
            key=$(echo "$key" | xargs)
            value=$(echo "$value" | xargs)
            echo "${key}=${value}" >> $GITHUB_ENV
          done < .github/versions.env

      - name: Install markdown linter
        run: npm install -g markdownlint-cli@${{ env.MARKDOWNLINT_CLI_VERSION }}

      - name: Lint markdown files
        run: |
          echo "ðŸ” Linting markdown files..."
          # Lint with relaxed rules (allow inline HTML, line length)
          markdownlint --config .markdownlint.json '**/*.md'
          echo "âœ… Markdown validation complete"

      - name: Check for broken internal links
        run: |
          echo "ðŸ” Checking for broken internal links..."
          # Simple check for file references
          find . -name "*.md" -type f | while read file; do
            # Extract markdown links [text](path)
            grep -oP '\]\(\K[^)]+' "$file" | while read link; do
              # Skip external links
              if [[ ! "$link" =~ ^http ]]; then
                # Check if referenced file exists (relative to the markdown file's location)
                dir=$(dirname "$file")
                if [ ! -f "$dir/$link" ] && [ ! -f "$link" ]; then
                  echo "âš ï¸ Potentially broken link in $file: $link"
                fi
              fi
            done
          done
          echo "âœ… Link check complete"
