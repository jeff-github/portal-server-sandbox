name: Build and Test

on:
  push:
    branches: [ main, release/** ]
  pull_request:
    branches: [ main ]

jobs:
  test-requirements-tools:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          cd tools/requirements
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          else
            echo "Error: requirements.txt not found"
            exit 1
          fi

      - name: Test requirement validation
        run: |
          echo "ðŸ” Testing requirement validation..."
          python3 tools/requirements/validate_requirements.py
          echo "âœ… Requirement validation passed"

      # Phase 4: Multi-sponsor traceability matrix generation
      # Generates combined (all sponsors) + per-sponsor reports
      # Output structure: build-reports/{combined|sponsor-name}/traceability/

      - name: Generate combined traceability matrix (Markdown)
        run: |
          echo "ðŸ” Testing combined traceability matrix generation (Markdown)..."
          python3 tools/requirements/generate_traceability.py \
            --mode combined \
            --format markdown \
            --output-dir build-reports/combined/traceability
          echo "âœ… Combined traceability matrix (Markdown) generated"

      - name: Generate combined traceability matrix (HTML)
        run: |
          echo "ðŸ” Testing combined traceability matrix generation (HTML)..."
          python3 tools/requirements/generate_traceability.py \
            --mode combined \
            --format html \
            --output-dir build-reports/combined/traceability
          echo "âœ… Combined traceability matrix (HTML) generated"

      - name: Generate per-sponsor traceability matrices
        run: |
          echo "ðŸ” Testing sponsor-specific traceability matrix generation..."
          # Get sponsor list from Doppler/environment
          # TODO: Pull from Doppler when available, hardcoded for now
          SPONSORS="callisto titan"
          for sponsor in $SPONSORS; do
            echo "Generating traceability for sponsor: $sponsor"
            python3 tools/requirements/generate_traceability.py \
              --mode sponsor \
              --sponsor $sponsor \
              --format markdown \
              --output-dir build-reports/$sponsor/traceability
            python3 tools/requirements/generate_traceability.py \
              --mode sponsor \
              --sponsor $sponsor \
              --format html \
              --output-dir build-reports/$sponsor/traceability
          done
          echo "âœ… Sponsor-specific traceability matrices generated"

      - name: Upload build reports as artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: build-reports-${{ github.sha }}
          path: build-reports/
          retention-days: 90

  test-linear-cli-tools:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Validate Linear API scripts
        run: |
          echo "ðŸ” Validating Linear API scripts syntax..."
          cd tools/anspar-cc-plugins/plugins/linear-api/scripts
          # Check all JavaScript files for syntax errors
          for file in *.js; do
            if [ -f "$file" ]; then
              node --check "$file" && echo "âœ… $file syntax valid" || exit 1
            fi
          done
          echo "âœ… All Linear API scripts validated"

  validate-documentation:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4

      - name: Load version pinning
        run: |
          # Export all versions from .github/versions.env to GitHub Actions environment
          while IFS='=' read -r key value; do
            # Skip comments and empty lines
            [[ "$key" =~ ^#.*$ ]] && continue
            [[ -z "$key" ]] && continue
            # Remove whitespace and export to GITHUB_ENV
            key=$(echo "$key" | xargs)
            value=$(echo "$value" | xargs)
            echo "${key}=${value}" >> $GITHUB_ENV
          done < .github/versions.env

      - name: Install markdown linter
        run: npm install -g markdownlint-cli@${{ env.MARKDOWNLINT_CLI_VERSION }}

      - name: Lint markdown files
        run: |
          echo "ðŸ” Linting markdown files..."
          # Lint with relaxed rules (allow inline HTML, line length)
          markdownlint --config .markdownlint.json '**/*.md'
          echo "âœ… Markdown validation complete"

      - name: Check for broken internal links
        run: |
          echo "ðŸ” Checking for broken internal links..."
          # Simple check for file references
          find . -name "*.md" -type f | while read file; do
            # Extract markdown links [text](path)
            grep -oP '\]\(\K[^)]+' "$file" | while read link; do
              # Skip external links
              if [[ ! "$link" =~ ^http ]]; then
                # Check if referenced file exists (relative to the markdown file's location)
                dir=$(dirname "$file")
                if [ ! -f "$dir/$link" ] && [ ! -f "$link" ]; then
                  echo "âš ï¸ Potentially broken link in $file: $link"
                fi
              fi
            done
          done
          echo "âœ… Link check complete"
