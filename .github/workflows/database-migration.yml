name: Database Migration Validation

on:
  push:
    paths:
      - 'database/**/*.sql'
  pull_request:
    paths:
      - 'database/**/*.sql'
  workflow_dispatch:

jobs:
  validate-migrations:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    env:
      # Database connection for all steps
      PGHOST: localhost
      PGPORT: 5432
      PGUSER: postgres
      PGPASSWORD: postgres
      PGDATABASE: test_db
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: test_db
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
      - uses: actions/checkout@v3

      - name: Install PostgreSQL client
        run: |
          sudo apt-get update
          sudo apt-get install -y postgresql-client
          which psql || (echo "ERROR: postgresql-client installation failed" && exit 1)

      - name: Test schema deployment
        run: |
          echo "Testing schema deployment..."
          psql --set ON_ERROR_STOP=1 -f database/schema.sql
          echo "Schema deployed successfully"

      - name: Test triggers
        run: |
          echo "Testing triggers..."
          psql --set ON_ERROR_STOP=1 -f database/triggers.sql
          echo "Triggers deployed successfully"

      - name: Test RLS policies
        run: |
          echo "Testing RLS policies..."
          psql --set ON_ERROR_STOP=1 -f database/rls_policies.sql
          echo "RLS policies deployed successfully"

      - name: Test indexes
        run: |
          echo "Testing indexes..."
          psql --set ON_ERROR_STOP=1 -f database/indexes.sql
          echo "Indexes deployed successfully"

      - name: Run database tests
        run: |
          echo "Running database tests..."
          psql --set ON_ERROR_STOP=1 -f database/tests/test_audit_trail.sql
          psql --set ON_ERROR_STOP=1 -f database/tests/test_compliance_functions.sql
          echo "Database tests passed"

      - name: Validate migration scripts
        env:
          PGHOST: localhost
          PGPORT: 5432
          PGUSER: postgres
          PGPASSWORD: postgres
          PGDATABASE: test_db
        run: |
          echo "Validating migration scripts have rollbacks..."
          for migration in database/migrations/*.sql; do
            if [ -f "$migration" ]; then
              filename=$(basename "$migration")
              # Extract migration number (e.g., "008" from "008_add_jsonb_validation.sql")
              migration_num=$(echo "$filename" | grep -oE '^[0-9]+')

              # Check for corresponding rollback using standard naming convention
              rollback_dir="database/migrations/rollback"
              rollback_file="${rollback_dir}/${migration_num}_rollback.sql"

              if [ ! -f "$rollback_file" ]; then
                echo "ERROR: Missing rollback for $migration"
                echo "Expected: $rollback_file"
                exit 1
              fi

              echo "Testing rollback for $migration: $rollback_file"

              # Apply migration to test database
              if ! psql --set ON_ERROR_STOP=1 -f "$migration" > /dev/null 2>&1; then
                echo "ERROR: Failed to apply migration $migration"
                exit 1
              fi

              # Apply rollback to test database
              if ! psql --set ON_ERROR_STOP=1 -f "$rollback_file" > /dev/null 2>&1; then
                echo "ERROR: Rollback failed for $rollback_file"
                exit 1
              fi

              # Re-apply migration to verify it can be applied again
              if ! psql --set ON_ERROR_STOP=1 -f "$migration" > /dev/null 2>&1; then
                echo "ERROR: Failed to re-apply migration $migration after rollback"
                exit 1
              fi

              echo "Rollback verified for $migration"
            fi
          done
          echo "All migrations have corresponding rollbacks and rollbacks are functional"
