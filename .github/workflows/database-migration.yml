name: Database Migration Validation

on:
  push:
    paths:
      - 'database/**/*.sql'
  pull_request:
    paths:
      - 'database/**/*.sql'
  workflow_dispatch:

jobs:
  validate-migrations:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    timeout-minutes: 10
    env:
      # Database connection for all steps
      PGHOST: localhost
      PGPORT: 5432
      PGUSER: postgres
      PGPASSWORD: postgres
      PGDATABASE: test_db
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: test_db
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
      - uses: actions/checkout@v4

      - name: Install PostgreSQL client
        run: |
          sudo apt-get update
          # Add PostgreSQL apt repo for version 17
          sudo sh -c 'echo "deb http://apt.postgresql.org/pub/repos/apt $(lsb_release -cs)-pgdg main" > /etc/apt/sources.list.d/pgdg.list'
          curl -fsSL https://www.postgresql.org/media/keys/ACCC4CF8.asc | sudo gpg --dearmor -o /etc/apt/trusted.gpg.d/postgresql.gpg
          sudo apt-get update
          # Pinned to PostgreSQL 17 (matches production database version)
          sudo apt-get install -y postgresql-client-17
          which psql || (echo "ERROR: postgresql-client-17 installation failed" && exit 1)

      - name: Deploy schema
        run: |
          echo "Deploying schema..."
          psql --set ON_ERROR_STOP=1 -f database/schema.sql
          echo "Schema deployed successfully"

      - name: Deploytriggers
        run: |
          echo "Deploying triggers..."
          psql --set ON_ERROR_STOP=1 -f database/triggers.sql
          echo "Triggers deployed successfully"

      - name: Deploy roles
        run: |
          echo "Deploying roles..."
          psql --set ON_ERROR_STOP=1 -f database/roles.sql
          echo "Roles deployed successfully"

      - name: Deploy RLS policies
        run: |
          echo "Deploying  RLS policies..."
          psql --set ON_ERROR_STOP=1 -f database/rls_policies.sql
          echo "RLS policies deployed successfully"

      - name: Deploy indexes
        run: |
          echo "Deploying indexes..."
          psql --set ON_ERROR_STOP=1 -f database/indexes.sql
          echo "Indexes deployed successfully"

      - name: Deploy tamper detection
        run: |
          echo "Deploying  tamper detection (hash triggers)..."
          psql --set ON_ERROR_STOP=1 -f database/tamper_detection.sql
          echo "Tamper detection deployed successfully"

      - name: Deploy compliance verification
        run: |
          echo "Deploying  compliance verification functions..."
          psql --set ON_ERROR_STOP=1 -f database/compliance_verification.sql
          echo "Compliance verification deployed successfully"

      - name: Run database tests
        run: |
          echo "Running database tests..."
          psql --set ON_ERROR_STOP=1 -f database/tests/test_audit_trail.sql
          psql --set ON_ERROR_STOP=1 -f database/tests/test_compliance_functions.sql
          echo "Database tests passed"

      - name: Validate migration scripts
        env:
          PGHOST: localhost
          PGPORT: 5432
          PGUSER: postgres
          PGPASSWORD: postgres
          PGDATABASE: test_db
        run: |
          echo "Validating migration scripts have rollbacks..."
          for migration in database/migrations/*.sql; do
            if [ -f "$migration" ]; then
              filename=$(basename "$migration")
              # Extract migration number (e.g., "008" from "008_add_jsonb_validation.sql")
              migration_num=$(echo "$filename" | grep -oE '^[0-9]+')

              # Check for corresponding rollback using standard naming convention
              rollback_dir="database/migrations/rollback"
              rollback_file="${rollback_dir}/${migration_num}_rollback.sql"

              if [ ! -f "$rollback_file" ]; then
                echo "ERROR: Missing rollback for $migration"
                echo "Expected: $rollback_file"
                exit 1
              fi

              echo "Testing rollback for $migration: $rollback_file"

              # Apply migration to test database
              if ! psql --set ON_ERROR_STOP=1 -f "$migration" > /dev/null 2>&1; then
                echo "ERROR: Failed to apply migration $migration"
                exit 1
              fi

              # Apply rollback to test database
              if ! psql --set ON_ERROR_STOP=1 -f "$rollback_file" > /dev/null 2>&1; then
                echo "ERROR: Rollback failed for $rollback_file"
                exit 1
              fi

              # Re-apply migration to verify it can be applied again
              if ! psql --set ON_ERROR_STOP=1 -f "$migration" > /dev/null 2>&1; then
                echo "ERROR: Failed to re-apply migration $migration after rollback"
                exit 1
              fi

              echo "Rollback verified for $migration"
            fi
          done
          echo "All migrations have corresponding rollbacks and rollbacks are functional"
