# IMPLEMENTS REQUIREMENTS:
#   REQ-d00028: Role-Based Environment Separation
#   REQ-d00031: Automated QA Testing
#   REQ-d00033: FDA Validation Documentation
#
# Clinical Diary QA Automation Workflow
# Triggers on pull requests to run automated tests in the qa container

name: QA Automation

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches:
      - main
      - 'feature/**'
      - 'release/**'
    paths:
      # Trigger on Docker environment changes
      - 'tools/dev-env/docker/**'
      - 'tools/dev-env/docker-compose.yml'
      - 'tools/dev-env/setup.sh'
      # Trigger on workflow changes
      - '.github/workflows/qa-automation.yml'
      # Trigger on application code changes (mounted as volume, but tests need to run)
      - 'apps/**'
      - 'packages/**'
      - 'database/**'
      - 'tests/**'
      - 'e2e/**'
      - 'pubspec.yaml'
      - 'package.json'
  workflow_dispatch:
    inputs:
      test_suite:
        description: 'Test suite to run (all, unit, integration, e2e)'
        required: false
        default: 'all'

env:
  # COHERENT CACHING: Use BuildKit with GHCR registry cache
  DOCKER_BUILDKIT: 1
  COMPOSE_DOCKER_CLI_BUILD: 1

jobs:
  qa-tests:
    name: Run QA Test Suite
    runs-on: ubuntu-latest

    permissions:
      contents: read
      pull-requests: write
      checks: write
      packages: read  # Required to pull images from GHCR

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for better git context

      - name: Detect Docker file changes
        id: docker-changes
        run: |
          # Check if any Docker-related files changed in this PR
          if git diff --name-only origin/main...${{ github.sha }} | grep -E '^tools/dev-env/docker/'; then
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "Docker files changed - will rebuild images"
          else
            echo "changed=false" >> $GITHUB_OUTPUT
            echo "No Docker changes - will pull pre-built images from GHCR"
          fi

      - name: Log in to GitHub Container Registry
        if: steps.docker-changes.outputs.changed == 'false'
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Pull pre-built images from GHCR
        if: steps.docker-changes.outputs.changed == 'false'
        run: |
          echo "Pulling pre-built images from GHCR..."

          # Pull and tag base image
          docker pull ghcr.io/${{ github.repository_owner }}/clinical-diary-base:latest
          docker tag ghcr.io/${{ github.repository_owner }}/clinical-diary-base:latest clinical-diary-base:latest

          # Pull and tag dev image
          docker pull ghcr.io/${{ github.repository_owner }}/clinical-diary-dev:latest
          docker tag ghcr.io/${{ github.repository_owner }}/clinical-diary-dev:latest clinical-diary-dev:latest

          # Pull and tag qa image
          docker pull ghcr.io/${{ github.repository_owner }}/clinical-diary-qa:latest
          docker tag ghcr.io/${{ github.repository_owner }}/clinical-diary-qa:latest clinical-diary-qa:latest

          echo "Images pulled and tagged successfully"

      - name: Set up Docker Buildx
        if: steps.docker-changes.outputs.changed == 'true'
        uses: docker/setup-buildx-action@v3

      - name: Build QA Docker images from source
        if: steps.docker-changes.outputs.changed == 'true'
        working-directory: tools/dev-env
        run: |
          echo "Docker files changed - building from source"

          # COHERENT CACHING: Use GHCR images as cache source via docker compose
          # Compose will build base -> dev -> qa in dependency order
          # BuildKit will pull layers from GHCR registry if available
          # Use CI override to limit resources to GitHub Actions constraints

          docker compose -f docker-compose.yml -f docker-compose.ci.yml build qa

          echo "Images built successfully"

      - name: Start QA environment
        working-directory: tools/dev-env
        run: |
          docker compose -f docker-compose.yml -f docker-compose.ci.yml up -d qa
          docker compose -f docker-compose.yml -f docker-compose.ci.yml ps

      - name: Wait for QA container to be healthy
        working-directory: tools/dev-env
        run: |
          timeout 60 bash -c 'until docker compose -f docker-compose.yml -f docker-compose.ci.yml exec -T qa /usr/local/bin/health-check.sh; do sleep 2; done'

      - name: Authenticate with Doppler (if configured)
        working-directory: tools/dev-env
        run: |
          if [ -n "${{ secrets.DOPPLER_TOKEN_QA }}" ]; then
            docker compose -f docker-compose.yml -f docker-compose.ci.yml exec -T qa bash -c "echo '${{ secrets.DOPPLER_TOKEN_QA }}' | doppler configure set token --scope /workspace"
          else
            echo "No Doppler token configured, skipping authentication"
          fi
        continue-on-error: true

      - name: Run Flutter unit tests
        id: flutter-tests
        working-directory: tools/dev-env
        run: |
          docker compose -f docker-compose.yml -f docker-compose.ci.yml exec -T qa bash -c "
            cd /workspace/repos/clinical-diary 2>/dev/null || echo 'No Flutter project found, skipping Flutter tests'
            if [ -f pubspec.yaml ]; then
              flutter pub get
              flutter test --coverage --reporter json > /workspace/reports/flutter-test-results.json || true
              flutter test --coverage
            fi
          "
        continue-on-error: true

      - name: Run Playwright E2E tests
        id: playwright-tests
        working-directory: tools/dev-env
        run: |
          docker compose -f docker-compose.yml -f docker-compose.ci.yml exec -T qa bash -c "
            cd /workspace/repos/clinical-diary 2>/dev/null || echo 'No Playwright tests found, skipping'
            if [ -d tests ] || [ -d e2e ]; then
              npx playwright test --reporter=json > /workspace/reports/playwright-results.json || true
              npx playwright test --reporter=html
            fi
          "
        continue-on-error: true

      - name: Run comprehensive QA suite
        id: qa-suite
        working-directory: tools/dev-env
        env:
          TEST_SUITE: ${{ github.event.inputs.test_suite || 'all' }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          COMMIT_SHA: ${{ github.sha }}
        run: |
          docker compose -f docker-compose.yml -f docker-compose.ci.yml exec -T qa bash -c "
            export TEST_SUITE='$TEST_SUITE'
            export PR_NUMBER='$PR_NUMBER'
            export COMMIT_SHA='$COMMIT_SHA'
            /usr/local/bin/qa-runner.sh
          "
        continue-on-error: true

      - name: Copy test reports from container
        if: always()
        working-directory: tools/dev-env
        run: |
          mkdir -p ../../qa-reports
          docker compose -f docker-compose.yml -f docker-compose.ci.yml cp qa:/workspace/reports/. ../../qa-reports/ || true
          ls -la ../../qa-reports/

      - name: Generate test summary
        if: always()
        run: |
          if [ -f qa-reports/test-summary.md ]; then
            cat qa-reports/test-summary.md >> $GITHUB_STEP_SUMMARY
          else
            echo "## QA Test Results" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Tests completed. See artifacts for detailed reports." >> $GITHUB_STEP_SUMMARY
          fi

      - name: Upload test reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: qa-test-reports-${{ github.sha }}
          path: qa-reports/
          retention-days: 30

      - name: Upload coverage reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-reports-${{ github.sha }}
          path: |
            qa-reports/coverage/
            qa-reports/lcov.info
          retention-days: 30
        continue-on-error: true

      - name: Comment PR with test results
        if: always() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            let comment = '## ðŸ¤– QA Automation Results\n\n';

            // Read test summary if available
            if (fs.existsSync('qa-reports/test-summary.md')) {
              const summary = fs.readFileSync('qa-reports/test-summary.md', 'utf8');
              comment += summary + '\n\n';
            }

            // Add artifact links
            comment += '### ðŸ“Š Detailed Reports\n\n';
            comment += `- [Test Reports Artifact](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})\n`;
            comment += `- Commit: \`${{ github.sha }}\`\n`;
            comment += `- Workflow: [View Logs](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})\n\n`;

            // Add timestamp
            comment += `*Generated at ${new Date().toISOString()}*\n`;

            // Post comment
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

      - name: Create check run with results
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            let conclusion = 'success';
            let summary = 'All QA tests passed';

            // Check for test failures
            if ('${{ steps.qa-suite.outcome }}' !== 'success') {
              conclusion = 'failure';
              summary = 'Some QA tests failed';
            }

            // Read detailed output if available
            let output = 'See artifacts for detailed test reports.';
            if (fs.existsSync('qa-reports/test-summary.md')) {
              output = fs.readFileSync('qa-reports/test-summary.md', 'utf8');
            }

            await github.rest.checks.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              name: 'QA Test Suite',
              head_sha: context.sha,
              status: 'completed',
              conclusion: conclusion,
              output: {
                title: 'QA Automation Results',
                summary: summary,
                text: output
              }
            });

      - name: Cleanup containers
        if: always()
        working-directory: tools/dev-env
        run: |
          docker compose -f docker-compose.yml -f docker-compose.ci.yml down -v

      - name: Fail workflow if tests failed
        if: steps.qa-suite.outcome == 'failure'
        run: exit 1

  security-scan:
    name: Security & Compliance Scan
    runs-on: ubuntu-latest
    needs: qa-tests
    if: github.event_name == 'pull_request'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'

      - name: Upload Trivy results to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: 'trivy-results.sarif'

      - name: Run SAST scan
        uses: github/codeql-action/analyze@v3
        continue-on-error: true
