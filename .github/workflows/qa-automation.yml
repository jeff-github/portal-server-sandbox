# IMPLEMENTS REQUIREMENTS:
#   REQ-d00028: Role-Based Environment Separation
#   REQ-d00031: Automated QA Testing
#   REQ-d00033: FDA Validation Documentation
#
# Clinical Diary QA Automation Workflow
# Triggers on pull requests to run automated tests in the qa container

name: QA Automation

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches:
      - main
      - 'feature/**'
      - 'release/**'
  workflow_dispatch:
    inputs:
      test_suite:
        description: 'Test suite to run (all, unit, integration, e2e)'
        required: false
        default: 'all'

env:
  # COHERENT CACHING: Use BuildKit with GHCR registry cache
  DOCKER_BUILDKIT: 1
  COMPOSE_DOCKER_CLI_BUILD: 1

jobs:
  qa-tests:
    name: Run QA Test Suite
    runs-on: ubuntu-latest

    permissions:
      contents: read
      pull-requests: write
      checks: write
      packages: write  # Required to push/pull images to/from GHCR

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for better git context

      - name: Check if QA tests should run
        id: check-qa-needed
        run: |
          echo "::group::Checking if QA tests are needed for this PR"

          # Check for skip label
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            LABELS="${{ join(github.event.pull_request.labels.*.name, ' ') }}"
            if echo "$LABELS" | grep -q "skip-qa"; then
              echo "qa_needed=false" >> $GITHUB_OUTPUT
              echo "â­ï¸  PR has 'skip-qa' label - skipping QA tests"
              echo "::endgroup::"
              exit 0
            fi
          fi

          # Get list of changed files
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            CHANGED_FILES=$(git diff --name-only ${{ github.event.pull_request.base.sha }} ${{ github.sha }})
          else
            # For workflow_dispatch, always run
            echo "qa_needed=true" >> $GITHUB_OUTPUT
            echo "âœ… Manual trigger - will run QA tests"
            echo "::endgroup::"
            exit 0
          fi

          # Patterns that require QA tests
          QA_PATTERNS=(
            '^packages/'           # Flutter package code
            '^apps/'              # Flutter app code
            '^lib/'               # Dart library code (if exists)
            '^test/'              # Test files
            '^tests/'             # Test files (alternate location)
            '^e2e/'               # E2E tests
            '^database/'          # Database changes might affect tests
            '^tools/dev-env/'     # Dev environment changes
            '\.dart$'             # Any Dart file
            '\.yaml$'             # pubspec.yaml or other config
            'docker-compose'      # Docker compose changes
            'Dockerfile'          # Dockerfile changes
            '^\.github/workflows/qa-automation\.yml$'  # This workflow itself
          )

          # Check if any changed file matches QA patterns
          QA_NEEDED=false
          for pattern in "${QA_PATTERNS[@]}"; do
            if echo "$CHANGED_FILES" | grep -qE "$pattern"; then
              QA_NEEDED=true
              echo "âœ… Found changes matching: $pattern"
              break
            fi
          done

          if [ "$QA_NEEDED" = "true" ]; then
            echo "qa_needed=true" >> $GITHUB_OUTPUT
            echo "âœ… QA tests are needed for this PR"
          else
            echo "qa_needed=false" >> $GITHUB_OUTPUT
            echo "â­ï¸  No QA-relevant changes detected - skipping tests"
            echo ""
            echo "Changed files:"
            echo "$CHANGED_FILES" | sed 's/^/  - /'
            echo ""
            echo "ðŸ’¡ To force QA tests, add the 'run-qa' label to this PR"
          fi

          echo "::endgroup::"

      - name: Skip QA tests (no relevant changes)
        if: steps.check-qa-needed.outputs.qa_needed == 'false'
        run: |
          echo "::notice::Skipping QA tests - no app/test code changes detected"
          echo "## â­ï¸ QA Tests Skipped" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "No QA-relevant changes detected in this PR." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**QA tests run when changes affect:**" >> $GITHUB_STEP_SUMMARY
          echo "- Flutter/Dart code (packages/, apps/, lib/)" >> $GITHUB_STEP_SUMMARY
          echo "- Test files (test/, tests/, e2e/)" >> $GITHUB_STEP_SUMMARY
          echo "- Database schema (database/)" >> $GITHUB_STEP_SUMMARY
          echo "- Dev environment (tools/dev-env/, Docker files)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ’¡ To force QA tests, add the 'run-qa' label to this PR" >> $GITHUB_STEP_SUMMARY

      - name: Detect Docker file changes
        if: steps.check-qa-needed.outputs.qa_needed == 'true'
        id: docker-changes
        run: |
          # Check if any Docker-related files changed in THIS PUSH (not entire PR vs main)
          # This allows subsequent commits without Docker changes to use fast pull path
          if git diff --name-only ${{ github.event.before }}..${{ github.sha }} | grep -E '^tools/dev-env/docker/'; then
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "Docker files changed in this push - will rebuild images"
          else
            echo "changed=false" >> $GITHUB_OUTPUT
            echo "No Docker changes in this push - will pull pre-built images from GHCR"
          fi

      - name: Free up disk space
        if: steps.check-qa-needed.outputs.qa_needed == 'true' && steps.docker-changes.outputs.changed == 'true'
        run: |
          echo "Disk space before cleanup:"
          df -h
          echo "Cleaning up unnecessary files..."
          docker image prune -af
          docker container prune -f
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /opt/ghc
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /usr/local/share/boost
          echo "Disk space after cleanup:"
          df -h

      - name: Log in to GitHub Container Registry
        if: steps.check-qa-needed.outputs.qa_needed == 'true'
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Pull pre-built images from GHCR
        if: steps.check-qa-needed.outputs.qa_needed == 'true' && steps.docker-changes.outputs.changed == 'false'
        id: pull-images
        continue-on-error: true
        run: |
          echo "Pulling pre-built images from GHCR..."

          # Docker requires lowercase repository names
          REPO_OWNER=$(echo "${{ github.repository_owner }}" | tr '[:upper:]' '[:lower:]')

          # Pull and tag images (allow failure if images don't exist yet)
          docker pull ghcr.io/${REPO_OWNER}/clinical-diary-base:latest || exit 1
          docker tag ghcr.io/${REPO_OWNER}/clinical-diary-base:latest clinical-diary-base:latest

          docker pull ghcr.io/${REPO_OWNER}/clinical-diary-dev:latest || exit 1
          docker tag ghcr.io/${REPO_OWNER}/clinical-diary-dev:latest clinical-diary-dev:latest

          docker pull ghcr.io/${REPO_OWNER}/clinical-diary-qa:latest || exit 1
          docker tag ghcr.io/${REPO_OWNER}/clinical-diary-qa:latest clinical-diary-qa:latest

          echo "Images pulled and tagged successfully"

      - name: Free up disk space for build (if pulling failed)
        if: steps.check-qa-needed.outputs.qa_needed == 'true' && steps.docker-changes.outputs.changed == 'false' && steps.pull-images.outcome == 'failure'
        run: |
          echo "Pull failed, need to build images. Freeing up disk space..."
          docker image prune -af
          docker container prune -f
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /opt/ghc
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /usr/local/share/boost

      - name: Set up Docker Buildx
        if: steps.check-qa-needed.outputs.qa_needed == 'true' && (steps.docker-changes.outputs.changed == 'true' || steps.pull-images.outcome == 'failure')
        uses: docker/setup-buildx-action@v3

      - name: Build and push Docker images to GHCR
        if: steps.check-qa-needed.outputs.qa_needed == 'true' && (steps.docker-changes.outputs.changed == 'true' || steps.pull-images.outcome == 'failure')
        working-directory: tools/dev-env
        run: |
          echo "Docker files changed - building from source with registry caching"

          # Docker requires lowercase repository names
          REPO_OWNER=$(echo "${{ github.repository_owner }}" | tr '[:upper:]' '[:lower:]')

          # PROPER REGISTRY-BASED CACHING:
          # 1. Pull existing images from GHCR for cache (|| true allows failure if not exists)
          # 2. Build each image (BuildKit uses cache_from to reuse layers from pulled images)
          # 3. Push to GHCR immediately so subsequent builds can use as cache
          # This ensures FROM directives can resolve from GHCR and layer caching works

          echo "Pulling previous images for cache..."
          docker pull ghcr.io/${REPO_OWNER}/clinical-diary-base:latest || true
          docker pull ghcr.io/${REPO_OWNER}/clinical-diary-dev:latest || true
          docker pull ghcr.io/${REPO_OWNER}/clinical-diary-qa:latest || true

          echo "Building base image..."
          docker compose --profile build-only -f docker-compose.yml -f docker-compose.ci.yml build base
          echo "Pushing base to GHCR..."
          docker tag clinical-diary-base:latest ghcr.io/${REPO_OWNER}/clinical-diary-base:latest
          docker push ghcr.io/${REPO_OWNER}/clinical-diary-base:latest

          echo "Building dev image (FROM GHCR base)..."
          docker compose --profile build-only -f docker-compose.yml -f docker-compose.ci.yml build dev --build-arg BASE_IMAGE=ghcr.io/${REPO_OWNER}/clinical-diary-base:latest
          echo "Pushing dev to GHCR..."
          docker tag clinical-diary-dev:latest ghcr.io/${REPO_OWNER}/clinical-diary-dev:latest
          docker push ghcr.io/${REPO_OWNER}/clinical-diary-dev:latest

          echo "Building qa image (FROM GHCR dev)..."
          docker compose --profile build-only -f docker-compose.yml -f docker-compose.ci.yml build qa --build-arg BASE_IMAGE=ghcr.io/${REPO_OWNER}/clinical-diary-dev:latest
          echo "Pushing qa to GHCR..."
          docker tag clinical-diary-qa:latest ghcr.io/${REPO_OWNER}/clinical-diary-qa:latest
          docker push ghcr.io/${REPO_OWNER}/clinical-diary-qa:latest

          echo "All images built and pushed to GHCR successfully"

      - name: Start QA environment
        if: steps.check-qa-needed.outputs.qa_needed == 'true'
        working-directory: tools/dev-env
        run: |
          docker compose -f docker-compose.yml -f docker-compose.ci.yml up --no-build -d qa
          docker compose -f docker-compose.yml -f docker-compose.ci.yml ps

      - name: Wait for QA container to be healthy
        if: steps.check-qa-needed.outputs.qa_needed == 'true'
        working-directory: tools/dev-env
        run: |
          timeout 60 bash -c 'until docker compose -f docker-compose.yml -f docker-compose.ci.yml exec -T qa /usr/local/bin/health-check.sh; do sleep 2; done'

      - name: Prepare repository in QA container
        if: steps.check-qa-needed.outputs.qa_needed == 'true'
        working-directory: tools/dev-env
        run: |
          docker compose -f docker-compose.yml -f docker-compose.ci.yml exec -T qa bash -c "
            mkdir -p /workspace/repos
            # Copy the checked-out repository from /workspace/src to expected location
            if [ ! -d /workspace/repos/clinical-diary ]; then
              echo 'Copying repository to /workspace/repos/clinical-diary...'
              cp -r /workspace/src /workspace/repos/clinical-diary
              echo 'Repository prepared successfully'
            else
              echo 'Repository already exists at /workspace/repos/clinical-diary'
            fi
          "

      - name: Authenticate with Doppler (if configured)
        if: steps.check-qa-needed.outputs.qa_needed == 'true'
        working-directory: tools/dev-env
        run: |
          if [ -n "${{ secrets.DOPPLER_TOKEN_QA }}" ]; then
            docker compose -f docker-compose.yml -f docker-compose.ci.yml exec -T qa bash -c "echo '${{ secrets.DOPPLER_TOKEN_QA }}' | doppler configure set token --scope /workspace"
          else
            echo "No Doppler token configured, skipping authentication"
          fi
        continue-on-error: true

      - name: Run Flutter unit tests
        if: steps.check-qa-needed.outputs.qa_needed == 'true'
        id: flutter-tests
        working-directory: tools/dev-env
        run: |
          docker compose -f docker-compose.yml -f docker-compose.ci.yml exec -T qa bash -c "
            cd /workspace/repos/clinical-diary 2>/dev/null || echo 'No Flutter project found, skipping Flutter tests'
            if [ -f pubspec.yaml ]; then
              flutter pub get
              flutter test --coverage --reporter json > /workspace/reports/flutter-test-results.json || true
              flutter test --coverage
            fi
          "
        continue-on-error: true

      - name: Run Playwright E2E tests
        if: steps.check-qa-needed.outputs.qa_needed == 'true'
        id: playwright-tests
        working-directory: tools/dev-env
        run: |
          docker compose -f docker-compose.yml -f docker-compose.ci.yml exec -T qa bash -c "
            cd /workspace/repos/clinical-diary 2>/dev/null || echo 'No Playwright tests found, skipping'
            if [ -d tests ] || [ -d e2e ]; then
              npx playwright test --reporter=json > /workspace/reports/playwright-results.json || true
              npx playwright test --reporter=html
            fi
          "
        continue-on-error: true

      - name: Run comprehensive QA suite
        if: steps.check-qa-needed.outputs.qa_needed == 'true'
        id: qa-suite
        working-directory: tools/dev-env
        env:
          TEST_SUITE: ${{ github.event.inputs.test_suite || 'all' }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          COMMIT_SHA: ${{ github.sha }}
        run: |
          docker compose -f docker-compose.yml -f docker-compose.ci.yml exec -T qa bash -c "
            export TEST_SUITE='$TEST_SUITE'
            export PR_NUMBER='$PR_NUMBER'
            export COMMIT_SHA='$COMMIT_SHA'
            /usr/local/bin/qa-runner.sh
          "
        continue-on-error: true

      - name: Copy test reports from container
        if: always()
        working-directory: tools/dev-env
        run: |
          mkdir -p ../../qa-reports
          docker compose -f docker-compose.yml -f docker-compose.ci.yml cp qa:/workspace/reports/. ../../qa-reports/ || true
          ls -la ../../qa-reports/

      - name: Generate test summary
        if: always()
        run: |
          if [ -f qa-reports/test-summary.md ]; then
            cat qa-reports/test-summary.md >> $GITHUB_STEP_SUMMARY
          else
            echo "## QA Test Results" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Tests completed. See artifacts for detailed reports." >> $GITHUB_STEP_SUMMARY
          fi

      - name: Upload test reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: qa-test-reports-${{ github.sha }}
          path: qa-reports/
          retention-days: 30

      - name: Upload coverage reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-reports-${{ github.sha }}
          path: |
            qa-reports/coverage/
            qa-reports/lcov.info
          retention-days: 30
        continue-on-error: true

      - name: Comment PR with test results
        if: always() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            let comment = '## ðŸ¤– QA Automation Results\n\n';

            // Read test summary if available
            if (fs.existsSync('qa-reports/test-summary.md')) {
              const summary = fs.readFileSync('qa-reports/test-summary.md', 'utf8');
              comment += summary + '\n\n';
            }

            // Add artifact links
            comment += '### ðŸ“Š Detailed Reports\n\n';
            comment += `- [Test Reports Artifact](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})\n`;
            comment += `- Commit: \`${{ github.sha }}\`\n`;
            comment += `- Workflow: [View Logs](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})\n\n`;

            // Add timestamp
            comment += `*Generated at ${new Date().toISOString()}*\n`;

            // Post comment
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

      - name: Cleanup containers
        if: always()
        working-directory: tools/dev-env
        run: |
          docker compose --profile build-only -f docker-compose.yml -f docker-compose.ci.yml down -v

      - name: Fail workflow if tests failed
        if: steps.check-qa-needed.outputs.qa_needed == 'true' && steps.qa-suite.outcome == 'failure'
        run: exit 1

  security-scan:
    name: Security & Compliance Scan
    runs-on: ubuntu-latest
    # Disabled: GitHub Code Scanning not available for private repos without GitHub Advanced Security
    if: false

    permissions:
      contents: read
      security-events: write  # Required to upload SARIF results
      actions: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'

      - name: Upload Trivy results to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: 'trivy-results.sarif'

      - name: Run SAST scan
        uses: github/codeql-action/analyze@v3
        continue-on-error: true
